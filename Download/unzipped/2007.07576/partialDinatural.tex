\section{A category of partial dinatural transformations}

Since dinatural transformations do not always compose, they do not form a category. However, the work done in Section~\ref{section vertical compositionality} permits us to define a category whose objects are functors of mixed variance and whose morphisms are transformations that are dinatural only in \emph{some} of their variables, as we shall see. A first attempt would be to construct $\fc \B \C$ by defining:
\begin{itemize}\label{first attempt}
    \item objects:  pairs $(\alpha, F \colon \B^\alpha \to \C)$;
    \item morphisms: a morphism $(\alpha, F) \to (\beta, G)$ would be a tuple  $(\phi, \graph\phi, \Delta_\phi)$ where $\phi \colon F \to G$ is a transformation whose standard graph is $\graph\phi$, and if $n$ is the number of connected components of $\graph\phi$ (hence, the number of variables of $\phi$), then $\Delta_\phi \colon n \to \{0,1\}$ would be the ``discriminant'' function that tells us in which variables $\phi$ is dinatural: if $\Delta_\phi(i)=1$, then $\phi$ is dinatural in its $i$-th variable;
    \item composition: given $(\phi,\graph\phi,\Delta_\phi) \colon (\alpha,F) \to (\beta,G)$ and $(\psi,\graph\psi,\Delta_\psi) \colon (\beta,G) \to (\gamma,H)$ morphisms, their composite would be $(\psi\circ\phi,\graph{\psi\circ\phi},\Delta_{\psi\circ\phi})$, where $\psi\circ\phi$ is simply the vertical composition of transformations $\phi$ and $\psi$, $\graph{\psi\circ\phi}$ is its standard graph, and $\Delta_{\psi\circ\phi}(x)$ is defined to be $1$ if and only if the $x$-th connected component of $\graph\psi \circ \graph\phi$ is acyclic and $\phi$ and $\psi$ are dinatural in all variables involved in the $x$-th connected component of the composite graph $\graph{\psi}\circ\graph\phi$, in the sense of Theorem~\ref{theorem:acyclicity implies dinaturality GENERAL}.
\end{itemize}
However, composition so defined fails to be associative in $\Delta$. Suppose we have three consecutive transformations $\phi$, $\psi$ and $\chi$, dinatural in all their variables, where
\[
\graph\phi = 
\begin{tikzpicture}
\matrix[column sep=2.4mm,row sep=0.4cm]{
    & \node [category] (1) {}; & & & & \node [opCategory] (6)  {}; \\
    & \node [component] (A)  {}; & & & & \node [component] (B) {};\\
    \node [category] (2) {}; & & \node [category] (3){}; & & \node [opCategory] (5)  {}; & & \node [opCategory] (7)  {};\\
};
\graph[use existing nodes]{
1 -> A -> {2,3};
5 -> B -> 6;
7 -> B;
};
\end{tikzpicture}
\quad
\graph\psi =
\begin{tikzpicture}
\matrix[column sep=2.4mm,row sep=0.4cm]{
	\node [category] (2) {}; & & \node [category] (3){}; & & \node [opCategory] (5)  {}; & & \node [opCategory] (7)  {};\\
\node [component] (C) {}; & & & \node [component] (D) {}; & & &\node [component] (E) {};	\\
\node [category] (4) {}; & & & & & & \node [opCategory] (8)  {};\\
};
\graph[use existing nodes]{
    	2 -> C -> 4;
        	3 -> D -> 5;
        8 -> E -> 7;
    };
    \end{tikzpicture} \quad 
    \graph\chi =
    \begin{tikzpicture}
    
    \matrix[column sep=2.4mm,row sep=0.4cm]{
    \node[category](2){}; & & & & \node[opCategory](5){}; \\
    & & \node[component](B){};\\
    };
\graph[use existing nodes]{
2 -> B -> 5;
};
    \end{tikzpicture}
\]
Of course vertical composition of transformations \emph{is} associative, therefore $(\chi \circ \psi) \circ \phi = \chi \circ (\psi \circ \phi)$ and $\graph{(\chi \circ \psi) \circ \phi} = \graph{\chi \circ (\psi \circ \phi)}$. Yet, $\Delta_{(\chi \circ \psi) \circ \phi} \ne \Delta_{\chi \circ (\psi \circ \phi)}$: indeed, by computing $\graph\chi \circ \graph\psi$ and then collapsing the connected components, we obtain
\[
\graph{\chi\circ\psi} =
\begin{tikzpicture}
	\matrix[column sep=2.4mm,row sep=0.4cm]{
    \node [category] (1) {}; & \node[category] (7) {}; & & \node[opCategory] (8) {}; & \node[opCategory] (6) {}; \\
    & & \node[component](D){}; \\
    & & \node[component](B){};\\
};
\graph[use existing nodes]{
1 -> B -> 6;
7 -> D -> 8;
};
\end{tikzpicture}
 \quad \text{hence }
\graph{\chi \circ \psi} \circ \graph\phi =
\begin{tikzpicture}
\matrix[column sep=2.4mm,row sep=0.4cm]{
    &\node[category](1){}; & & & &\node[opCategory](6){};\\
    &\node[component](A){};& & & &\node[component](C){};\\
    \node[category](2){}; & &\node[category](7){}; & &\node[opCategory](8){}; & &\node[opCategory](5){};\\
    & & &\node[component](D){};\\
    & & &\node[component](B){};\\
};
\graph[use existing nodes]{
    1 -> A -> 2 -> B ;
    B -> 5 -> C -> 6;
    A -> 7 -> D -> 8 -> C;
};
\end{tikzpicture}
\]
Since $\graph{\chi \circ \psi} \circ \graph\phi$ is acyclic, we have that $(\chi\circ\psi)\circ\phi$ is dinatural, thus $\Delta_{(\chi\circ\psi)\circ\phi} \colon 1 \to \{0,1\}$ is the function returning 1. On the other hand, however, we have
\[
\graph\psi \circ \graph\phi =
\begin{tikzpicture}
\matrix[column sep=2.4mm,row sep=0.4cm]{
    & \node [category] (1) {}; & & & & \node [opCategory] (6)  {}; \\
    & \node [component] (A)  {}; & & & & \node [component] (B) {};\\
    \node [category] (2) {}; & & \node [category] (3){}; & & \node [opCategory] (5)  {}; & & \node [opCategory] (7)  {};\\
    \node [component] (C) {}; & & & \node [component] (D) {}; & & &\node [component] (E) {};	\\
    \node [category] (4) {}; & & & & & & \node [opCategory] (8)  {};\\
};

\graph[use existing nodes]{
    1 -> A -> {2,3};
    2 -> C -> 4;
    3 -> D -> 5 -> B -> 6;
    8 -> E -> 7 -> B;
};
\end{tikzpicture}
\quad \text{so } 
\graph{\psi\circ\phi} = 
\begin{tikzpicture}
\matrix[column sep=3.5mm,row sep=0.4cm]{
    \node [category]  (1) {}; & & \node [opCategory] (2) {}; \\
    & \node [component]  (A) {}; \\
    \node [category]  (3) {}; & & \node [opCategory]  (4) {}; \\
};
\graph[use existing nodes]{
    1 -> A -> 3; 4 -> A -> 2;
};
\end{tikzpicture}
\]
which means that, when we glue together $\graph\chi$ and $\graph{\psi\circ\phi}$, we obtain:
\[
\graph{\chi}\circ\graph{\psi\circ\phi}= 
\begin{tikzpicture}
\matrix[column sep=3.5mm,row sep=0.4cm]{
    \node[category](1){}; & & \node[opCategory](6){};\\
    &\node[component](A){};\\
    \node[category](2){}; & & \node[opCategory](5){};\\
    &\node[component](B){};\\
};
\graph[use existing nodes]{
    1->A->2->B->5->A->6;	
};
\end{tikzpicture} 
\]
which is cyclic, so $\Delta_{\chi\circ(\psi\circ\phi)} \colon 1 \to \{0,1\}$ returns 0.

What went wrong? In the graph of $\psi\circ\phi$ there is a path from the bottom-right node to the bottom-left node, which then extends to a cycle once connected to $\graph{\chi}$. That path was created upon collapsing the composite graph $\graph\psi \circ \graph\phi$ into $\graph{\psi \circ \phi}$: 
%a single connected component: 
but in $\graph\psi \circ \graph\phi$ there was no path from the bottom-right node to the bottom-left one. And rightly so: to get a token moved to the bottom-left vertex of $\graph\psi \circ \graph\phi$, we have no need to put one token in the bottom-right vertex.  Therefore, once we have formed $\graph{\psi\circ\phi}$, we have lost  crucial information about which sources and sinks are \emph{directly} connected with which others, because we have collapsed the entire connected component into a single internal transition, with no internal places. As it happens, by computing the composite graph in a different order, instead, no new paths have been created, hence no cycles appear where there should not be. After all, by Theorem~\ref{theorem:acyclicity implies dinaturality GENERAL} we know that $\chi \circ \psi \circ \phi$ is dinatural because it can be written as the composite of two dinatural transformations, namely $\chi \circ \psi$ and $\phi$, whose composite graph is acyclic. 

This tells us that the crucial reason for which associativity fails in our preliminary definition of the category $\fc \B \C$ is that only keeping track of which connected component each of the arguments of the domain and codomain functors belongs to is not enough: we are forgetting too much information, namely the paths that directly connect the white and grey boxes. Hence our transformations will have to be equipped with more complicated Petri Nets than their standard graph that do contain internal places, and upon composition we shall simply link the graphs together along the common interface, without collapsing entire connected components into a single transition. 
    
Recall from Definition~\ref{def:FBCF petri net} that a FBCF Petri Net is a net where all the places have at most one input and at most one output transition. We now introduce the category of FBCF Petri Nets, using the usual definition of morphism for bipartite graphs.

\begin{definition}
    The category $\PN$ consists of the following data:
    \begin{itemize}
        \item objects are FBCF Petri Nets $N=(P_N,T_N,\inp{},\out{})$ together with a fixed ordering of its connected components. Such an ordering will allow us to speak about the ``$i$-th connected component'' of $N$;%such that $\length{\inp p} + \length{\out p} \ge 1$;
        \item a morphism $f \colon N \to M$ is a pair of functions $(f_P,f_T)$, for $f_P \colon P_N \to P_M$ and $f_T \colon T_N \to T_M$, such that for all $t \in T_N$
        \[
        \inp{f_T(t)} = \{f_P(p) \mid p \in \inp t \} \quad \text{and} \quad \out{f_T(t)} = \{ f_P(p) \mid p \in \out t  \}.
        \]
    \end{itemize}
\end{definition}

Note that if $f \colon N \to M$ is a morphism in $\PN$ then $f$ preserves (undirected) paths, hence for $C$ a connected component of $N$ we have that $f(C)$ is connected. In particular, if $f$ is an isomorphism then $f(C)$ is a connected component of $M$.

\begin{remark}\label{remark:finite sets are in PN}
    We have a canonical inclusion $\finset \to \PN$ by seeing a set as a Petri Net with only places and no transitions.	
\end{remark}

For a function $x \colon A \to B$ of sets we call $\parts x \colon \parts A \to \parts B$ the action of the covariant powerset functor on $x$, that is the function such that $\parts x (S) = \{x(a) \mid a \in S\} $ for $S \subseteq A$. We then have that if $f \colon N \to M$ is a morphism in $\PN$, then
\[
\begin{tikzcd}
T_N \ar[r,"f_T"] \ar[d,"\inp{}"'] & T_M \ar[d,"\inp{}"] \\
\parts{P_N} \ar[r,"\parts{f_P}"] & \parts{P_M}
\end{tikzcd}
\quad \text{and} \quad
\begin{tikzcd}
T_N \ar[r,"f_T"] \ar[d,"\out{}"'] & T_M \ar[d,"\out{}"] \\
\parts{P_N} \ar[r,"\parts{f_P}"] & \parts{P_M}
\end{tikzcd}
\]
commute by definition of the category $\PN$.

It turns out that $\PN$ admits pushouts, hence we can form a category $\cospan\PN$.

\begin{proposition}\label{prop: pushouts in PN}
    Let $N,M,L$ be in $\PN$, and consider the following diagram in $\PN$:
    \begin{equation}\label{diagram: pushout in PN}
    \begin{tikzcd}[column sep=3em]
    (P_N,T_N,\Inp {N} ,\Out {N} ) \ar[r,"{(g_P,g_T)}"] \ar[d,"{(f_P,f_T)}"'] & (P_L,T_L,\Inp L,\Out L ) \ar[d,"{(k_P,k_T)}"] \\
    (P_M,T_M,\Inp M,\Out M) \ar[r,"{(h_P,h_T)}"] & (P_Q,T_Q,\Inp Q,\Out Q)
    \end{tikzcd}
    \end{equation}
    where
    \[
    \begin{tikzcd}
    P_N \ar[r,"g_P"] \ar[d,"f_P"'] & P_L \ar[d,"k_P"] \\
    P_M \ar[r,"h_P"] & P_Q
    \end{tikzcd}
    \quad {and} \quad
    \begin{tikzcd}
    T_N \ar[r,"g_T"] \ar[d,"f_T"'] & T_L \ar[d,"k_T"] \\
    T_M \ar[r,"h_T"] & T_Q
    \end{tikzcd}
    \]
    are pushouts and $\Inp Q \colon T_Q \to \parts{P_Q}$ is the unique map (the dashed one) that makes the following diagram commute:
    \[
    \begin{tikzcd}
    \parts{P_N} \ar[dddr,bend angle=20,bend right,"\parts{f_P}"'] \ar[rrrd,bend angle=20,bend left,"\parts{g_P}"] \\
    & T_N \ar[r,"g_T"] \ar[d,"f_T"'] \ar[ul,"\Inp N"] & T_L \ar[d,"k_T"] \ar[r,"\Inp L"] & \parts{P_L} \ar[dd,"\parts{k_P}"] \\
    & T_M \ar[r,"h_T"] \ar[d,"\Inp M"] & T_Q \ar[dr,dashed] \\
    & \parts{P_M} \ar[rr,"\parts{h_P}"] & & \parts{P_Q}
    \end{tikzcd}
    \]
    $\Out Q \colon T_Q \to \parts{P_Q}$ is defined analogously. Then (\ref{diagram: pushout in PN}) is a pushout.
\end{proposition}
\begin{proof}
    It is easily checked that (\ref{diagram: pushout in PN}) satisfies the definition of pushout.\qed
\end{proof}

Remember from Remark~\ref{remark:finite sets are in PN} that finite sets can be seen as places-only Petri Nets: if $S$ is a set and $N$ is an object in $\PN$, then a morphism $f \colon S \to N$ in $\PN$ is a pair of functions $f=(f_P,f_T)$ where $f_T$ is the empty map $\emptyset \colon \emptyset \to T_N$. Hence, by little abuse of notation, we will refer to $f_P$ simply as $f$. 

For later convenience, we consider the following subcategory of $\cospan\PN$, whose morphisms are essentially Petri Nets $N$ in $\PN$ with ``interfaces'', that is specific places seen as ``inputs'' and ``outputs'' of $N$. Composition will then be computed by ``gluing together'' two consecutive nets along the common interface.

\begin{definition}\label{definition:graph category}
    The category $\gc$ consists of the following data:
    \begin{itemize}
        \item objects are lists in $\List\{+,-\}$;
        \item morphisms $f \colon \alpha \to \beta$ are (equivalence classes of) cospans in $\PN$ of the form
        \[
        \begin{tikzcd}
        \length\alpha \ar[r,"\lambda"] & N & \ar[l,"\rho"'] \length\beta
        \end{tikzcd}
        \]
        where 
        \begin{itemize}[leftmargin=*]
        \item $\lambda \colon \length\alpha \to P_N$ and $\rho \colon \length\beta \to P_N$ are injective functions, hence we can see $\length\alpha$ and $\length\beta$ as subsets of $P_N$; 
        \item $\mathit{sources}(N) = \{ \lambda(i) \mid \alpha_i=+ \} \cup \{ \rho(i) \mid \beta_i = - \}$;
        \item $\mathit{sinks}(N) = \{ \lambda(i) \mid \alpha_i=- \} \cup \{ \rho(i) \mid \beta_i = + \}$.
        \end{itemize}
        Two such cospans are in the same class if and only if they differ by an isomorphism of Petri Nets on $N$ coherent with $\lambda$, $\rho$ and the ordering of the connected components of $N$; 
        %where $N$ is a FBCF Petri Nets such that for all $p$ place $\length{\inp p} + \length{\out p} \ge 1$.
        \item composition is that of $\cospan\PN$. 
    \end{itemize}
\end{definition}

\begin{proposition}
    Composition in $\gc$ is well defined.
    \end{proposition}
\begin{proof}
Consider 
$
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\lambda"] & M & \ar[l,"\rho"'] \length\beta
\end{tikzcd}
$
and
$
\begin{tikzcd}[cramped,sep=small]
\length\beta \ar[r,"\lambda'"] & L & \ar[l,"\rho'"'] \length\gamma
\end{tikzcd}
$
two morphisms in $\gc$. By Proposition~\ref{prop: pushouts in PN} then, their composite is given by computing the pushouts
\[
\begin{tikzcd}
\length\beta \ar[r,"\lambda'"] \ar[d,"\rho"'] & P_L \ar[d,"k_P"] \\
P_M \ar[r,"h_P"] & P_Q
\end{tikzcd}
\quad \text{and} \quad
\begin{tikzcd}
\emptyset \ar[r,"\emptyset"] \ar[d,"\emptyset"'] & T_L \ar[d,"k_T"] \\
T_M \ar[r,"h_T"] & T_Q
\end{tikzcd}
\]
Now, the injectivity of $\rho$ and $\lambda'$ implies that $k_P$ and $h_P$ are also injective, as the pushout (in $\Set$) of an injective map against another yields injective functions. $P_Q$, in particular, can be seen as the quotient of $P_M + P_L$ where the elements of $P_M$ and $P_L$ with a common pre-image in $\length\beta$ are identified. Next, the pushout of the empty map against itself yields as a result the coproduct, thus $T_Q = T_M + T_L$ where $h_T$ and $k_T$ are the injections. Hence, the input function of the composite is defined as follows:
\[
\begin{tikzcd}[row sep=0em,ampersand replacement=\&]
T_M + T_L \ar[r,"\inp{}"] \& \parts{P_Q} \\
t \ar[r,|->] \& \begin{cases}
\inp{_M(t)} & t \in T_M \\
\inp{_L(t)} & t \in T_L
\end{cases}
\end{tikzcd}
\]
and similarly for the output function. All in all, therefore, composition in $\gc$ is computed by ``glueing'' together the Petri Nets $M$ and $L$ along the common $\length\beta$-places; the resulting morphism of $\gc$ is
\[
\begin{tikzcd}[column sep=3em]
\length\alpha \ar[r,"h_P \circ \lambda"] & L \circ M & \length\beta \ar[l,"k_P \circ \rho'"']. 
\end{tikzcd}
\]
Now, for all $i \in \length\beta$, if $\beta_i=+$ then $\rho(i)$ is a sink of $M$ and $\lambda'(i)$ a source of $L$; if $\beta_i=-$ instead then $\rho(i)$ is a source of $M$ and $\lambda'(i)$ a sink of $L$: in every case, once we glue together $M$ and $L$ along the $\length\beta$-places to form the composite net $L \circ M$, these become internal places of $L \circ M$, with at most one input and one output transition each (depending whether they are proper sources or sinks in $M$ and $L$). Hence $L \circ M$ is still a FBCF Petri Net, and 
\begin{align*}
\mathit{sources}(L \circ M) &= \bigl(\mathit{sources} (L) \setminus \rho(\length\beta) \bigr) \cup
\bigl(\mathit{sources} (L)\setminus \lambda'(\length\beta) \bigr) \\
&= \{h_P \circ \lambda(i) \mid \alpha_i = +\} \cup \{k_P \circ \rho'(i) \mid \gamma_i =-\}
\end{align*}
and similarly for $\mathit{sinks}(N' \circ N)$. \qed
\end{proof}



%Each representative of the equivalence class of any morphism 
%$
%\begin{tikzcd}[cramped,sep=small]
%\length\alpha \ar[r,"\sigma"] & N & \ar[l,"\tau"'] \length\beta
%\end{tikzcd}
%$
%in $\gc$ gives rise to a cospan in $\finset$
%$
%\begin{tikzcd}[cramped,sep=small]
%\length\alpha \ar[r,"\overline\sigma"] & n & \ar[l,"\overline\tau"'] \length\beta
%\end{tikzcd}
%$, where $n$ is the number of connected components of $N$: $\overline\sigma$ is the function that assigns to every element $i$ of $\length\alpha$ the number of the connected component to which $\sigma(i)$ belongs, and similarly for $\overline\tau$. Different representatives in $\gc$ yield equivalent cospans in $\finset$, hence the same morphism in $\cospan\finset$.
%
%\begin{proposition}
%    The construction above yields a functor $\skel {} {} {} \colon \gc \to \cospan\finset$, where $\skel \sigma \tau N$ is called the \emph{skeleton} of $(\sigma,\tau,N)$.
%\end{proposition}
%\begin{proof}
%    
%\end{proof}
%
%\begin{definition}
%    Let 
%    $
%    \begin{tikzcd}[cramped,sep=small]
%    \length\alpha \ar[r,"\sigma"] & N & \ar[l,"\tau"'] \length\beta
%    \end{tikzcd}
%    $
%    be a representative of a morphism $\alpha \to \beta$ in $\gc$. The cospan in $\finset$  
%    $
%    \begin{tikzcd}[cramped,sep=small]
%    \length\alpha \ar[r,"\overline\sigma"] & n & \ar[l,"\overline\tau"'] \length\beta
%    \end{tikzcd}
%    $
%    described above is said to be the \emph{skeleton} of $(\sigma,\tau,N)$ and is denoted by $\skel \sigma \tau N$.
%    
%    If $F \colon \B^\alpha \to \C$ and $G \colon \B^\beta \to \C$ are functors, we say that $\phi \colon F \to G$ is a \emph{transformation of graph $N$} if it is a transformation of type $\skel \sigma \tau N$.
%\end{definition}
%
%\begin{remark}
%    Any transformation $\phi$ is of graph $\graph\phi$, as the type of $\phi$ is, by construction, the skeleton of the standard graph $\graph\phi$.
%\end{remark}

\paragraph{Generalised graphs of a transformation}

We can now start working towards the definition of a category $\fc \B \C$ of functors of mixed variance and transformations that are dinatural only on some of their variables; $\fc \B \C$ will be a category over $\gcf$ in the sense that transformations in $\fc \B \C$ will carry along, as part of their data, certain cospans in $\PN$. The category of graphs $\gcf$ will be built from $\fc \B \C$ by forgetting the transformations. As such, $\gcf$ will be defined \emph{after} $\fc \B \C$.

It is clear how to define the objects of $\fc \B \C$: they will be pairs $(\alpha,F \colon \B^\alpha \to \C)$. Morphisms are less obvious to define, as we learnt in our preliminary attempt on p.~\pageref{first attempt}. A morphism $(\alpha,F) \to (\beta,G)$  will consist of a transformation $\phi \colon F \to G$ of type 
$
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
\end{tikzcd}
$, 
together though with a morphism 
$
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\overline\sigma "] & N & \length\beta \ar[l,"\overline\tau "']
\end{tikzcd}
$ in $\gc$ coherent with the type of $\phi$, in the sense that the Petri Net $N$, under certain conditions, looks exactly like $\graph\phi$ as in Definition~\ref{def:standard graph} except that it allows for internal places as well. For example, if $\psi_1$ and $\psi_2$ are two arbitrary consecutive transformations, $\graph{\psi_2} \circ \graph{\psi_1}$ will be coherent with the type of $\psi_2\circ\psi_1$. In other words, $N$ will have $n$ connected components, its sources (sinks) are exactly the places corresponding to the positive (negative) entries of $\alpha$ and the negative (positive) entries of $\beta$, and elements in $\length\alpha$ ($\length\beta$) mapped by $\sigma$ ($\tau$) into the same $i \in \{1,\dots,n\}$ will belong to the $i$-th connected component of $N$. A priori $N$ can contain places with no inputs or outputs: this will be useful for the special case of $\phi = \id F$ as we shall see in Theorem~\ref{theorem: {B,C} is a category}; however, if all sources and sinks in $N$ are proper, then $N$ plays the role of a generalised $\graph{\phi}$.

\begin{definition}\label{definition: generalised graph of transformation}
    Let $\phi \colon F \to G$ be a transformation of type
    $
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd}
    $.
    A cospan  
    $
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd}
    $ in $\PN$, which is a representative of a morphism in $\gc$  (hence $\overline\sigma$ and $\overline\tau$ are injective),
    is said to be \emph{coherent with the type of $\phi$} if and only if the following conditions are satisfied:
    \begin{itemize}[leftmargin=*]
        \item $N$ has $n$ connected components; %which are ordered from $1$ to $n$ (more precisely, we fix a bijection from the set of the connected components of $N$ to $\{1,\dots,n\}$);
        \item for all $i \in \length\alpha$ and $j \in \length\beta$, $\overline\sigma(i)$ belongs to the $\sigma(i)$-th connected component of $N$ and $\overline\tau(j)$ belongs to the $\tau(j)$-th connected component of $N$;
%        \item $\mathit{sources}(N) = \{ \overline\sigma(i) \mid \alpha_i=+ \} \cup \{ \overline\tau(i) \mid \beta_i = - \}$;
%        \item $\mathit{sinks}(N) = \{ \overline\sigma(i) \mid \alpha_i=- \} \cup \{ \overline\tau(i) \mid \beta_i = + \}$.
        %\item for all $i,j \in \length\alpha$, $\sigma(i)=\sigma(j)$ if and only if $\overline\sigma(i)$ and $\overline\sigma(j)$ belong to the same connected component;
        %\item for all $i,j \in \length\beta$, $\tau(i)=\tau(j)$ if and only if $\overline\tau(i)$ and $\overline\tau(j)$ belong to the same connected component;
        %\item for all $i \in \length\alpha$ and $j \in \length\beta$, $\sigma(i) = \tau(j)$ if and only if $\overline\sigma(i)$ and $\overline\tau(j)$ belong to the same connected component.
    \end{itemize}
    In this case we say that $N$ is a \emph{generalised graph of $\phi$}.
\end{definition}

\begin{example}\label{example: graph and type are a generalised graph}
    For $\phi \colon F \to G$ a transformation of type
    $
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd}
    $,
    recall that the set of places of $\graph\phi$ is $P = \length\alpha + \length\beta$. If we call $\injP {\length\alpha}$ and $\injP {\length\beta}$ the injections as in Definition~\ref{def:standard graph}, then
    \[
    \begin{tikzcd}
    \length\alpha \ar[r,"\injP{\length\alpha}"] & \Gamma(\phi) & \ar[l,"\injP{\length\beta}"'] \length\beta
    \end{tikzcd}
    \]
    is indeed coherent with the type of $\phi$.
    % Moreover, if $\sigma$ and $\tau$ are jointly epi, then 
    Also $
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd}
    $
    itself, seen as a cospan in $\PN$, is coherent with itself. %(If there is $i \in n$ that is not in the image of $\sigma$ or $\tau$, then the $i$-th place in $n$ seen as a Petri Net would be a source and a sink that would falsify the last two conditions of the definition.) 
\end{example}

\begin{remark}
    If $N$ is a generalised graph of $\phi$ as in the notations of Definition~\ref{definition: generalised graph of transformation} and does not have any place which is a source and a sink at once, then $N$ has exactly $\length\alpha + \length\beta$ sources and sinks and their union coincides with the joint image of $\overline\sigma$ and $\overline\tau$.  Moreover, $\overline\sigma$ and $\overline\tau$ have to make sure that they map elements of their domain into places belonging to the correct connected component: in this way, $N$ reflects the type of $\phi$ in a Petri Net like $\graph\phi$, with the possible addition of internal places.
    %If $N$ is a generalised graph of $\phi$ as in the notations of Definition~\ref{definition: generalised graph of transformation}, then the functions $\overline\sigma$ and $\overline\tau$ are completely determined by the type of $\phi$. Indeed, $\overline\sigma$ and $\overline\tau$ are injective by definition of morphism in $\gc$, and their joint image is the union of sources and sinks of $N$ (hence, in particular, $N$ has exactly $\length\alpha + \length\beta$ sources and sinks); moreover, $\overline\sigma$ and $\overline\tau$ have to make sure that they map elements of their domain into places belonging to the correct connected component: in this way, $N$ reflects the type of $\phi$ in a Petri Net like $\graph\phi$, with the possible addition of internal places.
\end{remark}

We shall now show how composition in $\gc$ preserves generalised graphs, in the following sense.

\begin{proposition}\label{proposition: composition in G preservers generalised graphs}
    Let $\phi \colon F \to G$ and $\psi \colon G \to H$ be transformations of type, respectively, 
    $
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd}
    $
    and
    $
    \begin{tikzcd}[cramped,sep=small]
    \length\beta \ar[r,"\eta"] & m & \length\gamma \ar[l,"\theta"']
    \end{tikzcd}
    $; let also 
    $u=
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd}
    $
    and
    $v=
    \begin{tikzcd}[cramped,sep=small]
    \length\beta \ar[r,"\overline\eta"] & N' & \length\gamma \ar[l,"\overline\theta"']
    \end{tikzcd}
    $
    be cospans in $\PN$ coherent with the type of $\phi$ and $\psi$, respectively. Suppose the type of $\psi \circ \phi$ is given by
    \[
    \begin{tikzcd}
    & & \length\gamma \ar[d,"\theta"] \\
    & \length\beta \ar[d,"\tau"'] \ar[r,"\eta"] \ar[dr, phantom, "\ulcorner" very near start] & m \ar[d,"\xi"] \\
    \length\alpha \ar[r,"\sigma"] & n \ar[r,"\zeta"] & l
    \end{tikzcd}
    \]
    and that the composite in $\gc$ of $u$ and $v$ is given by
    \begin{equation}\label{composite generalised graphs}
    \begin{tikzcd}
    & & \length\gamma \ar[d,"\overline\theta"] \\
    & \length\beta \ar[d,"\overline\tau"'] \ar[r,"\overline\eta"] \ar[dr, phantom, "\ulcorner" very near start] & N' \ar[d,"\overline\xi"] \\
    \length\alpha \ar[r,"\overline\sigma"] & N \ar[r,"\overline\zeta"] & N' \circ N
    \end{tikzcd}
    \end{equation}
    Then $v\circ u$ is coherent with the type of $\psi \circ \phi$.
\end{proposition}
\begin{proof}
    As we said in the discussion after Definition~\ref{definition:graph category}, $N' \circ N$ is obtained by gluing together $N$ and $N'$ along the $\length\beta$ places which they have in common. The number of connected components of $N' \circ N$ is indeed $l$ by construction. The morphisms $\overline\zeta$ and $\overline\xi$ in $\PN$ are pairs of injections that map each place and transition of $N$ and $N'$ to itself in the composite $N' \circ N$. This means that $\overline\zeta \overline\sigma(i)$ does belong to the $\zeta\sigma(i)$-th connected component of $N' \circ N$, as the latter contains the $\sigma(i)$-th c.c.\ of $N$; similarly the $\overline\xi \overline\theta (j)$ belongs to the $\xi\theta(j)$-th c.c.\ of $N' \circ N$.  \qed
\end{proof}

The morphisms of our generalised functor category $\fc \B \C$ will be, therefore, transformations $\phi$ equipped with a generalised graph $N$ and a discriminant function that tells us in which variables $\phi$ is dinatural. The Petri Net $N$ will not be arbitrary though: unless $\phi$ is an identity transformation, $N$ can be either $\graph\phi$ or $\graph{\phi_k} \circ \dots \circ \graph{\phi_1}$, for some consecutive transformations $\phi_1,\dots,\phi_k$ such that $\phi = \phi_k \circ \dots \phi_1$. Therefore, only transformations which are \emph{explicitly} recognisable as the composite of two or more families of morphisms are allowed to have an associated Petri Net, containing internal places, that is not their standard graph. 

Before we proceed with the definition of $\fc \B \C$, we need the following generalisation of Theorem~\ref{theorem:acyclicity implies dinaturality GENERAL}.

\begin{theorem}\label{theorem:compositionality with complicated graphs}
    Let $\phi_j \colon F_j \to F_{j+1}$ be transformations of type 
    $
    \begin{tikzcd}[cramped,sep=small]
    \length{\alpha^j} \ar[r,"\sigma_j"] & n_j & \ar[l,"\tau_j"'] \length{\alpha^{j+1}}
    \end{tikzcd}
    $
    for $j \in \{1,\dots,k\}$.
    Suppose that the type of $\phi_k \circ \dots \phi_1$ is computed by the following pushout-pasting:
    \[
    \begin{tikzcd}
        &   &   &   & \length{\alpha^{k+1}} \ar[d,"\tau_k"'] \\
        &   &   & \length{\alpha^k} \ar[r,"\sigma_k"] \ar[d] \ar[dr, phantom, "\ulcorner" very near start] & n_k \ar[d] \\
        &   & \length{\alpha^3} \ar[r] \ar[ur,sloped,phantom,"\dots"] \ar[d,"\tau_2"'] \ar[dr, phantom, "\ulcorner" very near start] & \dots \ar[r] \ar[d] \ar[dr, phantom, "\ulcorner" very near start] & \dots \ar[d] \\
        & \length{\alpha^2} \ar[r,"\sigma_2"] \ar[d,"\tau_1"'] \ar[dr, phantom, "\ulcorner" very near start] & n_2 \ar[r] \ar[d] \ar[dr, phantom, "\ulcorner" very near start] & \dots \ar[r] \ar[d] \ar[dr, phantom, "\ulcorner" very near start] & \dots \ar[d] \\
        \length{\alpha^1} \ar[r,"\sigma_1"] & n_1 \ar[r] & \dots \ar[r] & \dots \ar[r] & l
    \end{tikzcd}
    \]
    Let $\xi_j \colon n_j \to l$ be the map given by any path of morphisms from $n_j$ to $l$ in the above diagram. If the $i$-th connected component of $\graph{\phi_k} \circ \dots \circ \graph{\phi_1}$ (composite calculated in $\gc$) is acyclic and if for all $j \in  \{1,\dots,k\}$, for all $x \in \xi_j^{-1} \{i\}$ the transformation $\phi_j$ is dinatural in its $x$-th variable, then $\phi_k \circ \dots \circ \phi_1$ is dinatural in its $i$-th variable.
\end{theorem}
\begin{proof}
    The proof is essentially the same of Theorem~\ref{theorem:acyclicity implies dinaturality GENERAL}, where instead of two transformations we have $k$: one defines labelled markings $(M_0, L_0,f)$ and $(M_d,L_d,f)$ corresponding to the two legs of the dinaturality hexagon of $\phi_k \circ \dots \circ \phi_1$ in its $i$-th variable, and uses Theorem~\ref{thm:acyclic-implies-reachable} to prove that $M_d$ is reachable from $M_0$, thus showing the hexagon commutes. \qed
\end{proof}




\begin{definition}\label{def: generalised functor category}
    Let $\B$ and $\C$ be categories. The \emph{generalised functor category} $\fc \B \C$ consists of the following data:
    \begin{itemize}[leftmargin=*]
        \item objects are pairs $(\alpha,F)$, for $\alpha \in \List\{+,-\}$ and $F \colon \B^\alpha \to \C$ a functor;
    \item morphisms $(\alpha,F) \to (\beta,G)$ are equivalence classes of tuples
    \[
    \Phi = (\phi,
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd},
    %	\tf_{\phi,N},
    \Delta_\Phi
    )
    \]
    where:
            \begin{itemize}[leftmargin=*]
                \item $\phi \colon F \to G$ is a transformation of type
                $
                \begin{tikzcd}[cramped,sep=small]
                \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
                \end{tikzcd}
                $,
                \item $
                \begin{tikzcd}[cramped,sep=small]
                    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
                \end{tikzcd}
            $ is a representative of a morphism in $\gc$ coherent with the type of $\phi$,
            \item $\Delta_\Phi \colon n \to \{0,1\}$ is a function such that $\Delta_\Phi (i) = 1$ implies that the $i$-th connected component of $N$ is acyclic and $\phi$ is dinatural in its $i$-th variable.

    \end{itemize}
    Moreover: %, $\Phi$ above must be such that:
    \begin{itemize}[leftmargin=*]
        \item If $N$ consists of $n$ places and no transitions, then $(\alpha,F) = (\beta,G)$, $\phi=\id F$, $\sigma=\tau=\overline\sigma=\overline\tau=\id{\length\alpha}$ and $\Delta_\Phi = K_1$, the constant function equal to $1$; in this case $\Phi$ is the identity morphism of the object $(\alpha,F)$.
        \item If $N = \graph\phi$, $\overline\sigma = \injP{\length\alpha}$ and $\overline\tau=\injP{\length\beta}$, we say that $\Phi$ is \emph{atomic}.
        \item If $N \ne \graph\phi$ and $\Phi \ne \id{(\alpha,F)}$, then there exist $\Phi_1, \dots, \Phi_k$ atomic such that $\Phi = \Phi_k \circ \dots \circ \Phi_1$ in $\fc \B \C$, according to the composition law to follow in this Definition.
    \end{itemize}

    We say that $\Phi \eq \Phi'$, for $\Phi' = (\phi',
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma'"] & n & \length\beta \ar[l,"\tau'"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline{\sigma'}"] & N' & \length\beta \ar[l,"\overline{\tau'}"']
    \end{tikzcd},
    %\tf_{\phi',N'},
    \Delta_{\Phi'}
    )$,
    if and only if the transformations differ only by a permutation of their variables (in a coherent way with the rest of the data) and $N$ and $N'$ are coherently isomorphic: more precisely, when
    \begin{itemize}[leftmargin=*]
        \item there is a permutation $\pi \colon n \to n$ such that $\sigma'=\pi\sigma$, $\tau'=\pi\tau$, $\phi_{A_1,\dots,A_n}'=\phi_{A_{\pi 1},\dots,A_{\pi n}}$, $\Delta_{\Phi}=\Delta_{\Phi'} \pi$;
        \item there is an isomorphism $f=(f_P,f_T) \colon N \to N'$ in $\PN$ such that the following diagram commutes:
        \[
        \begin{tikzcd}
        \length\alpha \ar[r,"\overline\sigma"] \ar[dr,"\overline{\sigma'}"'] & N \ar[d,"f"] & \length\beta \ar[l,"\overline\tau"'] \ar[dl,"\overline{\tau'}"] \\
        & N' 
        \end{tikzcd}
        \]
        mapping the $i$-th connected component of $N$ to the $\pi(i)$-th connected component of $N'$. %and such that for all $(M' \colon P_{N'} \to \{0,1\}, L' \colon T_{N'} \to \{A,B\},g\colon A \to B) \in \LM(N')$ we have
        %		\[
        %		\tf_{\phi',N'}(M',L',g) = \tf_{\phi,N}(M'\circ f_p, L' \circ f_T,g)
        %		\]
        %		(remember that $f_P \colon P_N \to P_{N'}$ and $f_T \colon T_N \to T_{N'}$);
    \end{itemize}
\item Composition of $\Phi$ as above and
and 
\[
\Psi = 
(\psi,
\begin{tikzcd}[cramped,sep=small]
\length\beta \ar[r,"\eta"] & m & \ar[l,"\theta"'] \length\gamma
\end{tikzcd},
\begin{tikzcd}[cramped,sep=small]
\length\beta \ar[r,"\overline\eta"] & N' & \ar[l,"\overline\theta"'] \length\gamma
\end{tikzcd},
%	\tf_{\psi,N'},
\Delta_\Psi
) \colon (\beta,G) \to (\gamma, H)
\]
is component-wise: it is the equivalence class of the tuple 
\begin{equation}\label{eqn:composition in {B,C}}
\Psi \circ \Phi = (
\psi\circ\phi,
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\zeta\sigma"] & l & \ar[l,"\xi\theta"'] \length\gamma
\end{tikzcd},
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\overline\zeta \overline\sigma"] & {N'} \circ N & \ar[l,"\overline\xi \overline\theta"'] \length\gamma
\end{tikzcd},
%	\tf_{\psi\circ\phi,N'\circ N},
\Delta_{\Psi\circ\Phi}
)
\end{equation} 
where $\psi\circ\phi$ is the transformation of type given by the result of the pushout:
\[
\begin{tikzcd}
& & \length\gamma \ar[d,"\theta"] \\
& \length\beta \ar[d,"\tau"'] \ar[r,"\eta"] \ar[dr, phantom, "\ulcorner" very near start] & m \ar[d,"\xi"] \\
\length\alpha \ar[r,"\sigma"] & n \ar[r,"\zeta"] & l
\end{tikzcd}
\]
	$N' \circ N$ is computed by composing in $\gc$, that is by performing the pushout in $\PN$:
    \[
    \begin{tikzcd}
    & & \length\gamma \ar[d,"\overline\theta"] \\
    & \length\beta \ar[d,"\overline\tau"'] \ar[r,"\overline\eta"] \ar[dr, phantom, "\ulcorner" very near start] & N' \ar[d,"\overline\xi"] \\
    \length\alpha \ar[r,"\overline\sigma"] & N \ar[r,"\overline\zeta"] & N' \circ N
    \end{tikzcd}
    \]
    and the discriminant $\Delta_{\Psi\circ\Phi} \colon l \to \{0,1\}$ is obtained by setting $\Delta_{\Psi\circ\Phi} (x) = 1$ if and only if the $x$-th connected component of $N'\circ N$ is acyclic \emph{and} for all $y \in \zeta^{-1}\{x\}$ and $z \in \xi^{-1}\{x\}$ we have that $\Delta_\Phi(y) = 1 = \Delta_\Psi(z)$. The latter condition is tantamount to asking that $\phi$ and $\psi$ are dinatural in all the variables involved by the $x$-th connected component of the composite graph ${N'}\circ N$ of $\psi\circ\phi$.
\end{itemize}
\end{definition}

\begin{theorem}\label{theorem: {B,C} is a category}
    $\fc \B \C$ is indeed a category.
\end{theorem}
\begin{proof}
    First of all, if $\Phi$ and $\Psi$ as above are in $\fc \B \C$, it is not difficult to check that the equivalence class of $\Psi \circ \Phi$ as in~(\ref{eqn:composition in {B,C}}) does not depend on the choice of representatives for the classes of $\Phi$ and $\Psi$.
     
    Next, we aim to prove that $\Psi \circ \Phi$ is again a morphism of $\fc \B \C$. By Proposition~\ref{proposition: composition in G preservers generalised graphs} we have that ${N'} \circ N$ is a generalised graph for $\psi\circ\phi$. In order to prove that $\Delta_{\Psi\circ\Phi}$ correctly defines a morphism of $\fc \B \C$, that is that if $\Delta_{\Psi\circ\Phi}(i)=1$ then $\psi\circ\phi$ is indeed dinatural in its $i$-th variable, we first show that composition in $\fc \B \C$ is associative: once we have done that we will use Theorem~\ref{theorem:compositionality with complicated graphs} to conclude.
    
    Consider 
    \begin{align*}
    \Phi_1 &= (\phi_1,
    \begin{tikzcd}[cramped,sep=small,ampersand replacement=\&]
    \length\alpha \ar[r,"\sigma_1"] \& n \& \length\beta \ar[l,"\tau_1"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small,ampersand replacement=\&]
    \length\alpha \ar[r,"\overline{\sigma_1}"] \& N_1 \& \length\beta \ar[l,"\overline{\tau_1}"']
    \end{tikzcd},
    %	\tf_{\phi,N_1},
    \Delta_\Phi
    ) \colon (\alpha, F) \to (\beta, G), \\
    \Phi_2 &= (
    \phi_2,
    \begin{tikzcd}[cramped,sep=small,ampersand replacement=\&]
    \length\beta \ar[r,"\sigma_2"] \& m \& \length\gamma \ar[l,"\tau_2"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small,ampersand replacement=\&]
    \length\beta \ar[r,"\overline{\sigma_2}"] \& N_2 \& \length\gamma \ar[l,"\overline{\tau_2}"']
    \end{tikzcd},
    %		\tf_{\phi_2,N_2},
    \Delta_{\Phi_2}
    ) \colon (\beta, G) \to (\gamma, H), \\
    \Phi_3 &= (
    \phi_3,
    \begin{tikzcd}[cramped,sep=small,ampersand replacement=\&]
    \length\gamma \ar[r,"\sigma_3"] \& p \& \length\delta \ar[l,"\tau_3"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small,ampersand replacement=\&]
    \length\gamma \ar[r,"\overline{\sigma_3}"] \& N_3 \& \length\delta \ar[l,"\overline{\tau_3}"']
    \end{tikzcd},
    %		\tf_{\phi_3,N_3},
    \Delta_{\Phi_3}
    ) \colon (\gamma,H) \to (\delta,K).
    \end{align*}
    We know that composition of cospans via pushout is associative, as well as composition of transformations; suppose therefore that $\phi_3 \circ \phi_2 \circ \phi_1$ has type given by:
    \[
    \begin{tikzcd}
    & & & \length\delta \ar[d,"\tau_3"] \\
    & & \length\gamma \ar[r,"\sigma_3"] \ar[d,"\tau_2"'] \ar[dr, phantom, "\ulcorner" very near start] & p \ar[d,"\xi_2"] \\
    & \length\beta \ar[r,"\sigma_2"] \ar[d,"\tau_1"'] \ar[dr, phantom, "\ulcorner" very near start] & m \ar[r,"\zeta_2"] \ar[d,"\xi_1"'] \ar[dr, phantom, "\ulcorner" very near start] & q \ar[d,"\xi_3"] \\
    \length\alpha \ar[r,"\sigma_1"] & n \ar[r,"\zeta_1"] & l \ar[r,"\zeta_3"] & r
    \end{tikzcd}
    \]
    and the generalised graph $N_3 \circ N_2 \circ N_1$ is obtained as the result of the following pushout-pasting:
    \[
    \begin{tikzcd}
    & & & \length\delta \ar[d,"\overline{\tau_3}"] \\
    & & \length\gamma \ar[r,"\overline{\sigma_3}"] \ar[d,"\overline{\tau_2}"'] \ar[dr, phantom, "\ulcorner" very near start] & N_3 \ar[d,"\overline{\xi_2}"] \\
    & \length\beta \ar[r,"\overline{\sigma_2}"] \ar[d,"\overline{\tau_1}"'] \ar[dr, phantom, "\ulcorner" very near start] & N_2 \ar[r,"\overline{\zeta_2}"] \ar[d,"\overline{\xi_1}"'] \ar[dr, phantom, "\ulcorner" very near start] & N_3 \circ N_2 \ar[d,"\overline{\xi_3}"] \\
    \length\alpha \ar[r,"\overline{\sigma_1}"] & N_1 \ar[r,"\overline{\zeta_1}"] & N_2 \circ N_1 \ar[r,"\overline{\zeta_3}"] & N_3 \circ N_2 \circ N_1
    \end{tikzcd}
    \]
    We prove that $\Delta_{\Phi_3 \circ (\Phi_2 \circ \Phi_1)} = \Delta_{(\Phi_3 \circ \Phi_2) \circ \Phi_1}$. We have that $\Delta_{\Phi_3 \circ (\Phi_2 \circ \Phi_1)}(x) = 1$ if and only if, by definition:
    \begin{enumerate}[labelindent=0pt]
        \item[(1)] the $x$-th c.c.\ of $N_3 \circ N_2 \circ N_1$ is acyclic;
        \item[(2)] $\forall y \in \zeta_3^{-1}\{x\} \ldotp \Delta_{\Phi_2 \circ \Phi_1}(y) = 1$;
        \item[(3)] $\forall z \in (\xi_3 \circ \xi_2)^{-1}\{x\} \ldotp \Delta_{\Phi_3}(z) = 1$;
    \end{enumerate}
    which is equivalent to say that:
    \begin{enumerate}[labelindent=0pt]
        \item[(1)] the $x$-th c.c.\ of $N_3 \circ N_2 \circ N_1$ is acyclic;
        \item[(2a)] $\forall y \in l \ldotp \Bigl[ \zeta_3(y) = x \implies \text{$y$-th c.c.\ of $N_2 \circ N_1$ is acyclic} \Bigr] $;
        \item[(2b)] $\forall y \in l \ldotp \Bigl[ \zeta_3(y) = x \implies \forall a \in n \ldotp \Bigl( \zeta_1(a)=y \implies \Delta_{\Phi_1}(a)=1 \Bigr) \Bigr] $;
        \item[(2c)] $\forall y \in l \ldotp \Bigl[ \zeta_3(y) = x \implies \forall b \in m \ldotp \Bigl( \xi_1(b)=y \implies \Delta_{\Phi_2}(b)=1 \Bigr) \Bigr] $;
        \item[(3)] $\forall z \in p \ldotp \Bigl[ \xi_3\bigl(\xi_2(z)\bigr) = x \implies \Delta_{\Phi_3} (z) = 1 \Bigr] $.
    \end{enumerate}
    Call $A$ the conjunction of the conditions above. Next, we have that $\Delta_{(\Phi_3 \circ \Phi_2) \circ \Phi_1}(x)=1$ if and only if:
    \begin{enumerate}[labelindent=0pt]
        \item[(i)] the $x$-th c.c.\ of $N_3 \circ N_2 \circ N_1$ is acyclic;
        \item[(ii)] $\forall a \in n \ldotp \Bigl[ \zeta_3 \bigl( \zeta_1(a) \bigr) =x \implies \Delta_{\Phi_1}(a)=1\Bigr]$;
        \item[(iiia)] $\forall w \in q \ldotp \Bigl[ \xi_3(w)=x \implies \text{ $w$-th c.c.\ of $N_3 \circ N_2$ is acyclic } \Bigr]$;
        \item[(iiib)] $\forall w \in q \ldotp \Bigl[ \xi_3(w)=x \implies \forall b \in m \ldotp \Bigl( \zeta_2(b)=w \implies \Delta_{\Phi_2}(b)=1 \Bigr) \Bigr]$;
        \item[(iiic)] $\forall w \in q \ldotp \Bigl[ \xi_3(w)=x \implies \forall z \in p \ldotp \Bigl( \xi_2(z)=w \implies \Delta_{\Phi_3}(z)=1 \Bigr) \Bigr]$
    \end{enumerate}
    Call $B$ the conjunction of these last five conditions. We prove that $A$ implies $B$; in a similar way one can prove the converse as well.
    \begin{enumerate}[labelindent=0pt]
        \item[(ii)] Let $a \in n$, suppose $\zeta_3\bigl(\zeta_1(a)\bigr) = x$. By (2b), with $y = \zeta_1(a)$, we have $\Delta_{\Phi_1}(a) = 1$.
        \item[(iiia)] Let $w \in q$, suppose $\xi_3(w)=x$. Then the $w$-th c.c.\ of $N_3 \circ N_2$ must be acyclic as it is part of the $x$-th c.c.\ of $N_3 \circ N_2 \circ N_1$, which is acyclic.
        \item[(iiib)] Let $w \in q$, suppose $\xi_3(w)=x$. Let also $b \in m$ and suppose $\zeta_2(b) = w$. Then $x = \xi_3\bigl( \zeta_2(b)\bigr) = \zeta_3 \bigl(\xi_1(b)\bigr)$. By (2c), with $y = \xi_1(b)$, we have $\Delta_{\Phi_2}(b)=1$.
        \item[(iiic)] Let $w \in q$, suppose $\xi_3(w)=x$. Let $z \in p$ be such that $\xi_2(z)=w$. Then $\xi_3\bigl(\xi_2(z)\bigr)=x$: by (3), we have $\Delta_{\Phi_3}(z)=1$.
    \end{enumerate}
    
    Hence composition is associative. Take now $\Phi$ and $\Psi$ consecutive morphisms of $\fc \B \C$ as in the Definition of $\fc \B \C$. Then $\Phi=\Phi_k \circ \dots \circ \Phi_1$ for some $\Phi_j$'s, in particular $\phi=\phi_k \circ \dots \circ \phi_1$ for some $\phi_j$'s, and $\Delta_\Phi (i) =1 $ precisely when the $i$-th connected component of $N$ is acyclic and for all $j \in \{1,\dots,k\}$ the transformation $\phi_j$ is dinatural in all its variables involved in the $i$-th c.c.\ of $N$: one can see this by simply unfolding the definition of $\Delta_{\Phi_k \circ \dots \circ \Phi_1}$, extending the case of $\Delta_{\Phi_3 \circ \Phi_2 \circ \Phi_1}$ above. Similarly for $\Psi=\Psi_{k'} \circ \dots \Psi_1$, with $\psi = \psi_{k'} \circ \dots \psi_1$. We have then that if 
    \[
    N' \circ N = \graph{\psi_{k'}} \circ \dots \circ \graph{\psi_1} \circ \graph{\phi_k} \circ \dots \circ \graph{\phi_1}
    \]
    is acyclic in its $x$-th connected component and for all $y \in \zeta^{-1}\{x\}$ and $z \in \xi^{-1}\{x\}$ we have that $\Delta_\Phi(y) = 1 = \Delta_\Psi(z)$, then all the $\phi_j$'s and $\psi_j$'s are dinatural in all their variables involved in the $x$-th connected component of $N' \circ N$: by Theorem~\ref{theorem:compositionality with complicated graphs}, we have that $\psi\circ\phi$ is dinatural in its $x$-th variable. Hence $\Psi\circ\Phi$ is still a morphism of $\fc \B \C$.
    
    All that is left to prove is that composition is unitary where the identity morphism of $(\alpha,F)$ is given by the equivalence class of
    \[
    (
    \id F, 
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\id{}"] & \length\alpha & \ar[l,"\id{}"'] \length\alpha
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\id{}"] & \length\alpha & \ar[l,"\id{}"'] \length\alpha
    \end{tikzcd},
    K_1
    ),
    \]
    which is indeed a morphism of $\fc\B\C$ because, %$\id{\length\alpha}$ is an epimorphism, hence
     as discussed in Example~\ref{example: graph and type are a generalised graph} we have that $\length\alpha$ is a generalised graph for $\id F$; moreover, the identity transformation is indeed (di)natural in all its variables, therefore the constant function equal to $1$, $K_1$, is a valid discriminant function for $\id{\length\alpha}$.
    
    Let 
    \[
    \Phi = (\phi,
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd},
    %	\tf_{\phi,N},
    \Delta_\Phi
    ) \colon (\alpha,F) \to (\beta,G). 
    \]
    We prove that $\Phi \circ \id{(\alpha,F)} = \Phi$ and ${\id{(\beta,G)}} \circ \Phi = \Phi$ (by ``$\Phi$'' here we mean its equivalence class). It is clear that $\Phi \circ {\id{(\alpha,F)}}$ consists of $\phi$ together with its type and generalised graph as specified in $\Phi$. Also, $\Delta_{\Phi \circ \id{(\alpha,F)}}(x) = 1$ precisely when the $x$-th connected component of $N$ is acyclic and $\Delta_{\Phi}(x)=1$, by definition. Given that $\Delta_\Phi(x)=1$ implies that the $x$-th c.c.\ of $N$ is acyclic, we have that  $\Delta_{\Phi \circ \id{(\alpha,F)}} = \Delta_\Phi$. One can prove in a similar way the other identity law. \qed
    \end{proof}

\begin{remark}
    The condition ``$\Delta_\Phi(i)=1$ implies that the $i$-th connected component of $N$ is acyclic'' in Definition~\ref{def: generalised functor category} is designed to ignore dinaturality properties that happen to be satisfied ``by accident'', as it were, which could cause problems upon composition. Indeed, suppose that we have a transformation $\phi$ which is the composite of four transformations $\phi_1,\dots,\phi_4$, whose resulting generalised graph, obtained by pasting together $\Gamma(\phi_1),\dots,\Gamma(\phi_4)$, is as follows:
    \[
    N= \quad	\begin{tikzpicture}
    \matrix[column sep=2.4mm,row sep=0.4cm]{
        \node (1) [category] {}; \\
        \node (2) [component] {}; & & & \node (7) [component] {}; \\
        \node (3) [category] {}; & & \node (8) [category] {}; & & \node (6) [opCategory] {}; \\
        & \node (4) [component] {}; & & & \node (5) [component] {}; \\
        &	\node (A) [category] {}; & & & \node(F) [opCategory] {};\\
        &	\node (B) [component] {}; & & & \node(J) [component] {};\\
        \node (C) [category] {}; & & \node(D) [category] {}; & & \node(E) [opCategory] {};\\
        \node (H) [component] {}; & & & \node(I) [component] {};\\
        \node (G) [category] {}; & & & \\
    };
    \graph[use existing nodes]{
        1 -> 2 -> 3 -> 4 -> A -> B -> {C, D};
        C -> H -> G;
        D -> I -> E -> J -> F -> 5 -> 6 -> 7 -> 8 -> 4;
    };
    \node[coordinate](p) at (-2,0) {};
    \node[coordinate](q) at (2,0) {};
    \draw [dashed] (3.west -| p) -- (6.east -| q);
    \draw [dashed] (A.west -| p) -- (F.east -| q);
    \draw [dashed] (C.west -| p) -- (E.east -| q);
    \end{tikzpicture}
    \]
    Call $\Phi$ the tuple in $\fc \B \C$ consisting of $\phi$ with its type 
    $
    \begin{tikzcd}[cramped,sep=small]
    1 \ar[r] & 1 & 1 \ar[l]
    \end{tikzcd}
    $ and $N$ as a generalised graph, as a composite of the atomic morphisms of $\fc \B \C$ given by $\phi_1,\dots,\phi_4$. Suppose that $\phi$ happens to be dinatural in its only variable for some reason (extreme example: the category $\C$ is the terminal category). If in the definition of $\fc \B \C$ the only condition on $\Delta$ were ``$\Delta_\Phi(i) = 1$ implies $\phi$ dinatural in its $i$-th variable'', without requiring that the $i$-th connected component of $N$ be acyclic if $\Delta_\Phi(i)=1$, then equipping $\phi$ in $\Phi$ with a discriminant function $\Delta_\Phi$ defined as
    \[
    \begin{tikzcd}[row sep=0pt]
    1 \ar[r,"\Delta_\Phi"] & 1 \\
    1 \ar[r,|->] & 1
    \end{tikzcd}
    \] would be legitimate. Compose now $\Phi$ with the identity morphism of $\fc \B \C$: by definition we would obtain again $\Phi$ except for the discriminant function, which would be defined as $\Delta_{\Phi \circ \id{}}(1)=0$ because the composite graph, which is $N$, is not acyclic. Composition would not be unitary! The condition ``the $i$-th connected component of $N$ is acyclic whenever $\Delta_\Phi(i)=1$'' in Definition~\ref{def: generalised functor category} is therefore not only sufficient, but also necessary for unitarity of composition in $\fc \B \C$.
    
\end{remark}

\begin{remark}\label{remark:non-atomic morphisms of {B,C}}
    Although it is impossible, in general, to judge whether a transformation is or is not a composite of others by looking at its type, one can distinguish atomic morphisms of $\FC \B \C$ from composite morphisms by looking at the generalised graph $N$ they come  with. Indeed, if 
    \[
    \Phi = (\phi,
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd},
    %	\tf_{\phi,N},
    \Delta_\Phi
    )
    \]
    is a non-identity morphism of $\FC \B \C$, then $\Phi$ is atomic if and only if $N=\graph\phi$. In case $N \ne \graph\phi$, then $N$ contains internal places as a result of composing together ``atomic'' graphs of transformations: that is, we have that $\phi = \phi_k \circ \dots \circ \phi_1$ for some transformations $\phi_i$, and $N=\graph{\phi_k} \circ \dots \circ \graph{\phi_1}$. This decomposition of $\phi$ and $N$ is not necessarily unique.
\end{remark}

\paragraph{The category of graphs}

We can now finally individuate the category $\gcf$ of graphs of transformations. To do so, we will first build a category $\GC$, which will consist of those morphisms in $\gc$ that are the generalised graph of a transformation in $\fc \B \C$, together with a discriminant function. The category of graphs $\gcf$ we seek will be defined as a subcategory of it. 

We begin by defining the notion of \emph{skeleton} of a morphism in $\gc$, as it will be useful later on.

\begin{definition}
    Let 
    $
    f = \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \ar[l,"\overline\tau"'] \length\beta
    \end{tikzcd}
    $
    be a morphism in $\gc$, and let $n$ be the number of connected components of $N$. The \emph{skeleton} of the cospan $f$ is an (equivalence class of) cospan(s) in $\finset$
    \[
    \begin{tikzcd}
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd}
    \]
    where $\sigma(i)$ is the number of the connected component of $N$ to which $\overline\sigma(i)$ belongs to, and similarly is defined $\tau$.
\end{definition}

\begin{remark}
    If $\phi$ is a transformation and $N$ is a generalised graph of $\phi$, then the type of $\phi$ is the skeleton of $N$.
\end{remark}

The category $\GC$ will then consist of only part of the data of $\fc \B \C$, obtained, as it were, by discarding functors and transformations, and only considering the graphs and the discriminant functions.

\begin{definition}\label{definition:graph category definitive}
    The category $\GC$ of graphs consists of the following data.
    \begin{itemize}[leftmargin=*]
        \item Objects are lists in $\List\{+,-\}$.
        \item Morphisms $\alpha \to \beta$ are equivalence classes of pairs
        \[
        \bigl(
        \begin{tikzcd}
        \length\alpha \ar[r,"\overline\sigma"] & N & \ar[l,"\overline\tau"'] \length\beta
        \end{tikzcd},
        \Delta_N  \bigr)
        \]
        where:
        \begin{itemize}
            \item $(\overline\sigma,\overline\tau,N)$ is a morphism in $\gc$,
            \item let $n$ be the number of connected components of $N$: then $\Delta_N \colon n \to \{0,1\}$ is called \emph{discriminant function} and it is such that  $\Delta(i)=1$ implies that the $i$-th connected component of $N$ is acyclic.		
        \end{itemize}
        A pair above is equivalent to another $((\overline\sigma',\overline\tau',N'),\Delta_{N'})$, where $N'$ also has $n$ connected components, if and only if there exists $f \colon N \to N'$ an isomorphism in $\PN$ and $\pi \colon n \to n$ a permutation such that
        \[
        \begin{tikzcd}
        \length\alpha \ar[r,"\overline\sigma"] \ar[dr,"\overline{\sigma'}"'] & N \ar[d,"f"] & \length\beta \ar[l,"\overline\tau"'] \ar[dl,"\overline{\tau'}"] \\
        & N' 
        \end{tikzcd}
        \quad \text{and} \quad
        \begin{tikzcd}
        n \ar[r,"\Delta_N"] \ar[d,"\pi"'] & \{0,1\} \\
        n \ar[ur,"\Delta_N'"'] 
        \end{tikzcd}
        \]
        commute and $f$ maps the $i$-th c.c.\ of $N$ to the $\pi(i)$-th c.c.\ of $N'$.
        \item
        Composition is defined exactly as in $\fc \B \C$. To wit, composition of
        \[
        \bigl(
        \begin{tikzcd}
        \length\alpha \ar[r,"\overline\sigma"] & N & \ar[l,"\overline\tau"'] \length\beta
        \end{tikzcd},
        \Delta_N  \bigr)
        \quad \text{and} \quad
        \bigl(
        \begin{tikzcd}
        \length\beta \ar[r,"\overline\eta"] & N & \ar[l,"\overline\theta"'] \length\gamma
        \end{tikzcd},
        \Delta_{N'}  \bigr)
        \]
        is the equivalence class of the pair
        \[
        (
        \begin{tikzcd}
        \length\alpha \ar[r,"\overline\zeta \overline\sigma"] & {N'} \circ N & \ar[l,"\overline\xi \overline\theta"'] \length\gamma
        \end{tikzcd},
        %	\tf_{\psi\circ\phi,N'\circ N},
        \Delta_{g \circ f}
        )
        \]
        where $N' \circ N$ is the Petri Net given by the result of the pushout
        \[
        \begin{tikzcd}
        & & \length\gamma \ar[d,"\overline\theta"] \\
        & \length\beta \ar[d,"\overline\tau"'] \ar[r,"\overline\eta"] \ar[dr, phantom, "\ulcorner" very near start] & N' \ar[d,"\overline\xi"] \\
        \length\alpha \ar[r,"\overline\sigma"] & N \ar[r,"\overline\zeta"] & N' \circ N
        \end{tikzcd}
        \] 
        and $\Delta_{N' \circ N}$ is defined as follows. If
        $
        \begin{tikzcd}[cramped,sep=small]
        \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
        \end{tikzcd}
        $
        and 
        $
        \begin{tikzcd}[cramped,sep=small]
        \length\beta \ar[r,"\eta"] & m & \length\gamma \ar[l,"\theta"']
        \end{tikzcd}
        $
        are the skeletons of $(\overline\sigma,\overline\tau,N)$ and $(\overline\eta,\overline\theta,N')$ respectively, then the skeleton of $(\overline\zeta\overline\sigma,\overline\xi\overline\theta,N'\circ N)$ is given by the pushout 
        \[
        \begin{tikzcd}
        & & \length\gamma \ar[d,"\theta"] \\
        & \length\beta \ar[d,"\tau"'] \ar[r,"\eta"] \ar[dr, phantom, "\ulcorner" very near start] & m \ar[d,"\xi"] \\
        \length\alpha \ar[r,"\sigma"] & n \ar[r,"\zeta"] & l
        \end{tikzcd}
        \]
        (cf.\ Proposition~\ref{proposition: composition in G preservers generalised graphs}). Define therefore $\Delta_{N' \circ N}(x)=1$ if and only if the $x$-th connected component of $N'\circ N$ is acyclic \emph{and} for all $y \in \zeta^{-1}\{x\}$ and $z \in \xi^{-1}\{x\}$ we have that $\Delta_N(y) = 1 = \Delta_{N'}(z)$.
    \end{itemize}
\end{definition}

\begin{definition}
    The category $\gcf$ of graphs is the wide subcategory  of $\GC$ (that is, it contains all the objects of $\GC$) generated by equivalence classes of pairs
    \[
    \bigl(
    \begin{tikzcd}
    \length\alpha \ar[r,"\overline\sigma"] & N & \ar[l,"\overline\tau"'] \length\beta
    \end{tikzcd},
    \Delta_N  \bigr)
    \]
    where $P_N=\length\alpha + \length\beta$, $\overline\sigma=\injP{\length\alpha}$, $\overline\tau = \injP{\length\beta}$ and for all $p$ place, $\length{\inp p} + \length{\out p} = 1$ (equivalently, $N$ has no internal places and every place is either a proper source or a proper sink). Hence, the general morphism of $\gcf$ is either:
    \begin{itemize}
        \item an identity 
        $
        \bigl( 
        \begin{tikzcd}[cramped,sep=small]
        \length\alpha \ar[r,"\id{}"] & \length\alpha & \ar[l,"\id{}"'] \length\alpha
        \end{tikzcd},
        K_1
        \bigr),
        $
        \item a generator satisfying the conditions above; such morphisms are called \emph{atomic},
        \item a finite composite of atomic morphisms. 
    \end{itemize}
\end{definition}

The assignment $(\alpha,F) \mapsto \alpha$ and 
\[
\bigl[(\phi,
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
\end{tikzcd},
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\injP{\length\alpha}"] & \ggraph\phi & \length\beta \ar[l,"\injP{\length\beta}"']
\end{tikzcd},
%	\tf_{\phi,N},
\Delta_\Phi
)\bigr] 
\mapsto \Bigl[\bigl(
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\injP{\length\alpha}"] & \ggraph\phi & \length\beta \ar[l,"\injP{\length\beta}"']
\end{tikzcd}, \Delta_\Phi \bigr)\Bigr]
\]
mapping atomic morphisms of $\FC \B \C$ to atomic morphisms of $\gcf$ uniquely extends to a functor $\gf \colon \FC \B \C \to \gcf$. Moreover, $\gf$ has two special properties, by virtue of the ``modularity'' of our $\FC \B \C$ and $\gcf$ and the fact that all and only atoms in $\FC \B \C$ have atomic images: it reflects compositions and identities. By ``reflects identities'' we mean that if $\Phi \colon (\alpha,F) \to (\alpha,F)$ is such that $\gf(\Phi)=\id{\length\alpha}$, then $\Phi=\id{(\alpha,F)}$. By ``reflects compositions'' we mean that if $\Phi$ is a morphism in $\FC \B \C$ and $\gf(\Phi)$ is not atomic, i.e.\ $\gf(\Phi) = (N_k,\Delta_k) \circ \dots \circ (N_1,\Delta_1)$ with $(N_i,\Delta_i)$ atomic in $\gcf$, then there must exist $\Phi_1,\dots,\Phi_k$ morphisms in $\FC \B \C$ such that:
\begin{itemize}
    \item $\Phi = \Phi_k \circ \dots \circ \Phi_1$,
    \item $\gf(\Phi_i) = (N_i,\Delta_i)$.
\end{itemize}
Hence, say $\Phi = 
(\phi,
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
\end{tikzcd},
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
\end{tikzcd},
%	\tf_{\phi,N},
\Delta_\Phi
)
$: then there must exist transformations $\phi_i$ with graph $\graph{\phi_i}$ (hence atomic), dinatural according to $\Delta_i$, such that $\phi = \phi_k \circ \dots \circ \phi_1$, cf.\ Remark~\ref{remark:non-atomic morphisms of {B,C}}. In other words, $\gf$ satisfies the following definition.

\begin{definition}
    Let $\D,\E$ be any categories. A functor $P \colon \D \to \E$ is said to be a \emph{weak Conduch fibration} (WCF) if, given $f \colon A \to B$ in $\D$:
    \begin{itemize}
        \item $P(f)=\id{}$ implies $f=\id{}$;
        \item given a decomposition $P(f)=u \circ v$ in $\E$, we have that there exist $g,h$ in $\D$ such that $f = g \circ h$, $P(g) = u$, $P(h)=v$.
    \end{itemize}	 
    We define $\WCFover \E$ to be the full subcategory of $\catover\E$ whose objects are the categories over $\E$ whose augmentation is a weak Conduch fibration.
\end{definition}

We have then proved the following theorem.


\begin{theorem}
    $\FC \B \C$ is an object of $\,\,\WCFover\gcf$.
\end{theorem}

Conduch fibrations were introduced in~\cite{conduche_au_1972} as a re-discovery after the original work of Giraud~\cite{giraud_methode_1964} on exponentiable functors in slice categories. Our  notion is weaker in not requiring the additional  property of uniqueness of the decomposition $f=g \circ h$ up to equivalence, where we say that two factorisations $g \circ h$ and $g' \circ h'$ are equivalent if there exists a morphism $j \colon \codom h \to \dom {g'}$ such that everything in sight commutes in the following diagram:
\[
\begin{tikzcd}
& \codom{h} \ar[r,"g"] \ar[d,"j"] & B \\
A \ar[ur,"h"] \ar[r,"h'"'] & \dom{g'} \ar[ur,"g'"']
\end{tikzcd}
\]
We will not, in fact, need such uniqueness; moreover, it is not evident whether our $\gf$ is a Conduch fibration or not.

\begin{remark}
    The fact that $\FC \B \C$ is not just an object of $\catover\gcf$, but even of $\WCFover\gcf$, will allow us to build the substitution category $\ring \A \B$ just for categories $\A$ over $\gcf$ whose augmentation is more than a mere functor: it is a weak Conduch fibration. %Indeed, ultimately we will be interested in a functor $\mu \colon \ring {\FC \B \C} {\FC \A \B} \to \FC \A \C$, like Kelly, that will embody the substitution calculus: this means that as long as the domain of $\ring{}{}$ contains $\FC \B \C$, we will be content. 
    The main advantage of restricting our attention to $\WCFover\gcf$ is that a category $\A$ in it inherits, in a sense, the modular structure of $\gcf$, as we shall see in the next Lemma.
\end{remark}

\begin{definition}
    Let $P \colon \D \to \gcf$ be an object of $\WCFover\gcf$. A morphism $d$ in $\D$ is said to be \emph{atomic} if $P(d)$ is atomic.
\end{definition}

\begin{lemma}\label{lemma:functors determined by atoms in WCF over E}
    Suppose that, in the following diagram, $P$ is a weak Conduch fibration and $Q$ is an ordinary functor.
    \[
    \begin{tikzcd}[column sep={1cm,between origins}]
    \D \ar[rr,"Q"] \ar[dr,"P"'] & & \mathbb F  \\
    & \gcf
    \end{tikzcd}
    \]
    Then $Q$ is completely determined on morphisms by the image of atomic morphisms of $\D$.
\end{lemma}
\begin{proof}
    Let $d \colon D \to D'$ be a morphism in $\D$ with $P(D)=\alpha$, $P(D')=\beta$ and $P(d) = \bigl[ \bigl(
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd}, \Delta_d \bigr) \bigr]
    $. If $P(d)$ is not atomic, then either $P(d)=\id{}$, in which case $d=\id{}$ (because $P$ is a weak Conduch fibration), or $P(d)=(N_k,\Delta_k) \circ \dots \circ (N_1,\Delta_1)$ for some (not necessarily unique) atomic $(N_i,\Delta_i)$. Hence there must exist $d_1,\dots,d_k$ in $\D$ such that $d=d_k \circ \dots \circ d_1$ and $P(d_i)=(N_i,\Delta_i)$. Then $Q(d)$ will necessarily be defined as $\id{}$ in the first case, or as $Q(d_k) \circ \dots \circ Q(d_1)$ in the second case, otherwise $Q$ would not be a functor. \qed
\end{proof}

\section{The category of formal substitutions}\label{section:category of formal substitutions}

Kelly~\cite{kelly_many-variable_1972}, after defining his generalised functor category $\fc \B \C$ for covariant functors and many-variable natural transformations only, 
%(his $\fc \B \C$ is a category over $\Per$, the category of natural numbers and permutations that serves as a category of graphs for his natural transformations),
proceeds by showing that the functor $\fc \B -$
%\colon \Cat \to \WCFover\Per$ 
has a left adjoint, which he denotes with $\ring - \B$. The category $\ring \A \B$ will be essential to capture the central idea of substitution. 

Here we aim to do the same in our more general setting where $\fc \B \C$ comprises mixed-variance functors and many-variable, partial dinatural transformations. First, we give an explicit definition of the functor $\FC \B - \colon \Cat \to \WCFover\gcf$. Given a functor $K \colon \C \to \C'$, we define $\FC \B K \colon \FC \B \C \to \FC \B {\C'}$ to be the functor mapping $(\alpha,F \colon \B^\alpha \to \C)$ to $(\alpha,KF \colon \B^\alpha \to \C')$; and if 
\[
\Phi = (\phi,
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
\end{tikzcd},
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
\end{tikzcd},
%\tf_{\phi,N},
\Delta_\Phi
)
\colon (\alpha,F) \to (\beta,G)
\]
is a morphism in $\FC \B \C$, then $\FC \B K (\Phi)$ is obtained by whiskering $K$ with $\phi$, obtaining therefore a transformation with the same type and generalised graph as before, with the same dinaturality properties:
\[
\FC \B K (\Phi) = (
K\phi,
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
\end{tikzcd},
\begin{tikzcd}[cramped,sep=small]
\length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
\end{tikzcd},
%(K \times K) \circ \tf_{\phi,N},
\Delta_\Phi
).
\]
In particular, $\FC \B K$ is clearly a functor over $\gcf$. It is a classic exercise in Category Theory to prove that $\fc \B -$ is continuous, see~\cite[Theorem 3.52]{santamaria_towards_2019}, which is a necessary condition for the existence of a left adjoint
\[
\ring - \B \colon \WCFover\gcf \to \Cat.
\]
We shall prove that a left adjoint does exist by first constructing the category $\ring \A \B$ explicitly, and then showing the existence of a universal arrow $(\A \circ \B, F_\A \colon \A \to \FC \B {\ring \A \B})$ from $\A$ to $\FC \B -$: this will yield the desired adjunction. 

To see what $\ring \A \B$ looks like, we follow Kelly's strategy: we aim to prove that there is a natural isomorphism
\[
\Cat ( \ring \A \B, \C) \cong \WCFover\gcf (\A, \FC \B \C)
\]
and we use this to deduce how $\ring \A \B$ must be. Write $\Gamma$ for all augmentations (as weak Conduch fibrations) over $\gcf$, and let $\Phi$ be an element of $\,\WCFover\gcf(\A,\FC \B \C)$. We now spell out all we can infer from this fact. To facilitate reading, and to comply with Kelly's notation in~\cite{kelly_many-variable_1972}, we shall now refer to the $\bfA$-th component of a transformation $\phi$, for $\bfA=(A_1,\dots,A_m)$ say, as $\phi(\bfA)$ instead of $\phi_{\bfA}$.

\begin{enumerate}[(a),wide,labelindent=0pt]
    \item \label{PhiA} For all $A \in \A$, $\Gamma(A)=\alpha$ we have $\Phi A \colon \B^\alpha \to \C$ is a functor, hence 
    \begin{enumerate}[label=(a.\roman*),wide,leftmargin=\parindent]
        \item for every $\bfB=(B_1,\dots,B_{\length\alpha})$ object of $\B^\alpha$, $\Phi A (\bfB)$ is an object of $\C$,\label{PhiA(B1...Balpha)}
        \item for all $\bfg=(g_1,\dots,g_{\length\alpha})$, with $g_i \colon B_i \to B_i'$ a morphism in $\B$, we have 
        \[
        \Phi(A)(\bfg) \colon  \funminplus {\Phi A} {B_i'} {B_i} i {\length\alpha} \to \funminplus {\Phi A} {B_i} {B_i'} i {\length\alpha}
        \]
        is a morphism in $\C$.\label{PhiA(g1...galpha)}
    \end{enumerate}
    This data is subject to functoriality of $\Phi A$, that is:
    \begin{enumerate}[(1),wide,leftmargin=\parindent]
        \item For every $\bfB$ object of $\B^\alpha$, $\Phi A (\id\bfB) = \id{\Phi A (\bfB)}$\label{PhiA(1...1)=1PhiA}.
        \item For $\bfh=(h_1,\dots,h_{\length\alpha})$, with $h_i \colon B_i' \to B_i''$ morphism of $\B$,
        \[
        \funminplus {\Phi A} {g_i \circ_{\Op\B} h_i} {h_i \circ_{\B} g_i} i {\length\alpha}
        =
        \funminplus {\Phi A} {g_i} {h_i} i {\length\alpha} \circ \funminplus {\Phi A} {h_i} {g_i} i {\length\alpha}.
        \]\label{PhiA(hg)=PhiA(h)PhiA(g)}
    \end{enumerate}
    \item \label{Phif}For all $f \colon A \to A'$ in $\A$ with
    $
    \Gamma(f) = \Bigl[\bigl(
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd},\Delta_f
    \bigr) \Bigr]
    $, we have that $\Phi f$ is an equivalence class of transformations whose graphs are representatives of $\Gamma(f)$, such transformations being dinatural in some variables according to $\Delta_f$. %(By Lemma~\ref{lemma:functors determined by atoms in WCF over E}, $\Phi$ is completely determined on morphisms by its image of such $f$'s.) 
    Hence for all $\xi = \bigl((\overline\sigma, \overline\tau, N),\Delta_\xi\bigr) \in \Gamma(f)$ we have a transformation $\Phi f_\xi \colon \Phi A \to \Phi A'$ whose type
    $
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd}
    $ 
    is the skeleton of $(\overline\sigma,\overline\tau,N)$ and
    %is uniquely determined by $\xi$ ($n$ is the number of connected components of $N$, $\sigma(i)$ is the number of the connected component of $N$ to which $\overline\sigma(i)$ belongs, and similarly for $\tau$), 
    with discriminant function $\Delta_\xi$ that tells us in which variables $\Phi f_\xi$ is dinatural. Therefore to give $\Phi f$ one has to provide, for all $\xi = \bigl((\overline\sigma, \overline\tau, N),\Delta_\xi\bigr) \in \Gamma(f)$, for every $\bfB=(B_1,\dots,B_n)$ object of $\B^n$, a morphism in $\C$
    \[
    \Phi f_\xi (\bfB) \colon \Phi A (\bfB\sigma) \to \Phi A' (\bfB\tau)
    \]
    such that:
    \begin{enumerate}[(1),start=3,wide,leftmargin=\parindent]
        \item for all $\pi \colon n \to n$ permutation, $\Phi f_{\pi\xi}(\bfB) = \Phi f_\xi (\bfB\pi)$,\label{Phif_pixi(Bi)=Phif_xi(Bpii)}
        \item \label{Phif_xi dinatural} for $\bfB'=(B_1',\dots,B_n')$ in $\B^n$ and for $\bfg=(g_1,\dots,g_n) \colon \bfB \to \bfB'$ in $\B^n$, where if $\Delta_\xi(i)=0$ then $B_i=B_i'$ and $g_i = \id {B_i}$, the following hexagon commutes:
        \[
        \begin{tikzcd}[font=\normalsize, column sep={0.5cm}]
        & \Phi A (\bfB\sigma) \ar[rrr,"{\Phi f_\xi (\bfB)}"] 
        & &&  \Phi A' (\bfB\tau) \ar[dr,"\funminplus{\Phi A'}{B_{\tau i}}{g_{\tau i}} i {\length\beta}"] \\
        \funminplus{\Phi A}{B_{\sigma i}'}{B_{\sigma i}} i {\length\alpha} \ar[ur,"{\funminplus{\Phi A}{g_{\sigma i}}{B_{\sigma i}} i {\length\alpha}}"]
        \ar[dr,"\funminplus{\Phi A} {{B_{\sigma i}}} {{g_{\sigma i}}} i {\length\alpha}"'] & & && 
        & \funminplus {\Phi A'} {B_{\tau i}}{B_{\tau i}'} i {\length\beta} \\
        & \Phi A (\bfB'\sigma) 
        \ar[rrr,"{\Phi f_\xi (\bfB')}"']
        & & &\Phi A'(\bfB'\tau) 
        \ar[ur,"\funminplus{\Phi A'}{g_{\tau i}}{B_{\tau i}} i {\length\beta}"']
        \end{tikzcd}
        \]
    \end{enumerate}
    \item The data provided in \ref{PhiA} and \ref{Phif} is subject to the functoriality of $\Phi$ itself, hence:
    \begin{enumerate}[(1),start=5,wide,leftmargin=\parindent]
        \item $\Phi(\id A) = \id{\Phi A}$, \label{Phi(1A)=1_Phi(A)}
        \item for $f \colon A \to A'$ and $f' \colon A' \to A''$, $\Phi(f' \circ_{\A} f) = {\Phi f'} \circ_{\FC \B \C} {\Phi f}$ \label{Phi(f2 f1)=Phi(f2) Phi(f1)}.
    \end{enumerate}
\end{enumerate}

We now mirror all the data and properties of a functor $\Phi \colon \A \to \FC \B \C$ over $\gcf$ to define the category $\ring \A \B$. 

\begin{definition}\label{definition A ring B}
    Let $\A$ be a category over $\gcf$ via a weak Conduch fibration $\Gamma \colon \A \to \gcf$, and let $\B$ be any category. The category $\ring \A \B$ of \emph{formal substitutions} of elements of $\B$ into those of $\A$ is the free category generated by the following data. We use the same enumeration as above to emphasise the correspondence between each piece of information.
    \begin{itemize}[wide=0pt,leftmargin=*]
        \item[\ref{PhiA(B1...Balpha)}] Objects are of the form $A[\bfB]$, for $A$ an object of $\A$ with $\Gamma(A)=\alpha$, and for  $\bfB=(B_1,\dots,B_{\length\alpha})$ in $\B^\alpha$. As it is standard in many-variable calculi, we shall drop a set of brackets and write $A[B_1,\dots,B_{\length\alpha}]$ instead of $A[(B_1,\dots,B_{\length\alpha})]$.
        \item[\ref{PhiA(g1...galpha)},\ref{Phif}] Morphisms are to be generated by
        \[
        A[\bfg] \colon \funminplussq A {B_i'} {B_i} i {\length\alpha} \to \funminplussq A {B_i} {B_i'} i {\length\alpha}
        \]
       for $A$ in $\A$ with $\Gamma(A)=\alpha$, $\bfg=(g_1,\dots,g_{\length\alpha})$ and $g_i \colon B_i \to B_i'$ in $\B$, %where
%        \[
%        C_i = \begin{cases}
%        B_i & \alpha_i = + \\
%        B_i' & \alpha_i = -
%        \end{cases}
%        \qquad
%        D_i = \begin{cases}
%        B_i' & \alpha_i = + \\
%        B_i & \alpha_i = -
%        \end{cases}
%        \]
        %cf.~\ref{PhiA(g1...galpha)}, 
        and by
        \[
        f_{\xi}[\bfB] \colon A[\bfB\sigma] \to A'[\bfB\tau]
        \]
        for $f \colon A \to A'$ in $\A$, 
        $
        \xi = \bigl(
        \begin{tikzcd}[cramped,sep=small]
        \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
        \end{tikzcd},\Delta_\xi \bigr)
        $
        a representative of $\Gamma(f)$, $(\sigma,\tau,n)$ the skeleton of $(\overline\sigma,\overline\tau,N)$, $\bfB=(B_1,\dots,B_n)$ object of $\B^n$. %, cf.~\ref{Phif};
    \end{itemize}
    Such data is subject to the following conditions:
    \begin{itemize}[wide=0pt,leftmargin=*]
        \item[\ref{Phif_pixi(Bi)=Phif_xi(Bpii)}] For every permutation $\pi \colon n \to n$ and for every $\bfB=(B_1,\dots,B_n)$ object of $\B^n$
        \[
        f_{\pi\xi}[\bfB] = f_\xi[\bfB\pi].
        \] %cf.~\ref{Phif_pixi(Bi)=Phif_xi(Bpii)};
        \item[\ref{PhiA(1...1)=1PhiA},\ref{Phi(1A)=1_Phi(A)}] For all $A\in\A$ with $\Gamma(A)=\alpha$ and for every $\bfB=(B_1,\dots,B_{\length\alpha})$ object of $\B^\alpha$ 
        \[
        A[\id\bfB] = \id{A[\bfB]} = {\id A}[\bfB].
        \]
        %cf.~\ref{PhiA(1...1)=1PhiA} and \ref{Phi(1A)=1_Phi(A)};
        \item[\ref{PhiA(hg)=PhiA(h)PhiA(g)}] For all $A \in \A$ with $\Gamma(A)=\alpha$, for all $g_i \colon B_i \to B_i'$ and $h_i \colon B_i' \to B_i''$ in $\B$, $i \in \{1,\dots,\length\alpha\}$
       \[
       \funminplussq { A} {g_i \circ_{\Op\B} h_i} {h_i \circ_{\B} g_i} i {\length\alpha}
       =
       \funminplussq { A} {g_i} {h_i} i {\length\alpha} \circ \funminplussq { A} {h_i} {g_i} i {\length\alpha}.
       \]
        \item[\ref{Phi(f2 f1)=Phi(f2) Phi(f1)}] For all $f \colon A \to A'$ and $f' \colon A' \to A''$ in $\A$, for all
        \[
        \bigl( 
        \begin{tikzcd}[cramped,sep=small]
        \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
        \end{tikzcd},\Delta
        \bigr) \in \Gamma(f) \quad \text{and} \quad
        \bigl(
        \begin{tikzcd}[cramped,sep=small]
        \length\beta \ar[r,"\overline\eta"] & M & \ar[l,"\overline\theta"'] \length\gamma
        \end{tikzcd},\Delta'
        \bigr) \in \Gamma(f'),
        \]
        with $(\sigma,\tau,n)$ and $(\eta,\theta,m)$ the skeletons of, respectively, $(\overline\sigma,\overline\tau,N)$ and $(\overline\eta,\overline\theta,M)$,
        and for all choices of a pushout
        \[
        \begin{tikzcd}
        & & \length\gamma \ar[d,"\theta"] \\
        & \length\beta \ar[d,"\tau"'] \ar[r,"\eta"] \ar[dr,phantom,very near start,"\ulcorner"] & m \ar[d,"\xi"] \\
        \length\alpha \ar[r,"\sigma"] & n \ar[r,"\zeta"] & l
        \end{tikzcd}
        \]
        each choice determining the skeleton of (the first projection of) a representative of $\Gamma(f' \circ f)$, and for all $\bfB=(B_1,\dots,B_l)$ object of $\B^l$
        \[
        f'_{(\eta,\theta)}[\bfB\xi] \circ f_{(\sigma,\tau)}[\bfB\zeta] = (f'\circ f)_{(\zeta\sigma,\xi\theta)}[\bfB].
        \] 
        %cf.~\ref{Phi(f2 f1)=Phi(f2) Phi(f1)};
        \item[\ref{Phif_xi dinatural}] For all $f \colon A \to A'$, $\xi= \bigl(
        \begin{tikzcd}[cramped,sep=small]
        \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
        \end{tikzcd}, \Delta_\xi \bigr) \in \Gamma(f)
        $,
        with
        $(\sigma,\tau,n)$ the skeleton of $(\overline\sigma,\overline\tau,N)$, for all $\bfB=(B_1,\dots,B_n)$, $\bfB'=(B_1',\dots,B_n')$ objects of $\B^n$ and for all $\bfg=(g_1,\dots,g_n) \colon \bfB \to \bfB'$, with $B_i=B_i'$ and  $g_i=\id{B_i}$ if $\Delta_\xi(i)=0$, the following hexagon commutes:
        \begin{equation}\label{f[g1...gn]}
        \begin{tikzcd}[column sep={0.5cm}]
        & A[\bfB\sigma] \ar[rrr,"{f_\xi [\bfB]}"] 
        & &&  A' [\bfB\tau] \ar[dr,"\funminplussq{A'}{B_{\tau i}}{g_{\tau i}} i {\length\beta}"] \\
        \funminplussq{A}{B_{\sigma i}'}{B_{\sigma i}} i {\length\alpha} \ar[ur,"{\funminplussq{A}{g_{\sigma i}}{B_{\sigma i}} i {\length\alpha}}"]
        \ar[dr,"\funminplussq{A} {{B_{\sigma i}}} {{g_{\sigma i}}} i {\length\alpha}"'] & & && 
        & \funminplussq { A'} {B_{\tau i}}{B_{\tau i}'} i {\length\beta} \\
        & A [\bfB'\sigma] 
        \ar[rrr,"{f_\xi [\bfB']}"']
        & & & A'[\bfB'\tau] 
        \ar[ur,"\funminplussq{A'}{g_{\tau i}}{B_{\tau i}} i {\length\beta}"']
        \end{tikzcd}
        \end{equation}
        We will denote the diagonal of \ref{f[g1...gn]} as $f[\bfg]$. 
        %cf.~\ref{Phif_xi dinatural}.
    \end{itemize}
\end{definition}

\begin{remark}
    By \ref{Phi(1A)=1_Phi(A)} and \ref{PhiA(hg)=PhiA(h)PhiA(g)}, we have
    \[
    A[\bfg] = \id A [\bfg]
    \]
    and by \ref{PhiA(1...1)=1PhiA}, we have
    \[
    f[\bfB] = f[\id\bfB]
    \]
    which is coherent with the usual notation of $A$ for $\id A$.
\end{remark}

Since two consecutive morphisms both of type \ref{PhiA(g1...galpha)} or both of type \ref{Phif} can be merged together into a single one by \ref{PhiA(hg)=PhiA(h)PhiA(g)} and \ref{Phi(f2 f1)=Phi(f2) Phi(f1)}, we have no way, in general, to swap the order of a morphism of type $A[\bfg]$ followed by one of the form $f_\xi[\bfB]$, because the only axiom that relates the two generators is (\ref{f[g1...gn]}). Therefore, all we can say about the general morphism of $\ring \A \B$ is that it is a string of compositions of alternate morphisms of type \ref{PhiA(g1...galpha)}  and \ref{Phif}, subject to the equations \ref{PhiA(1...1)=1PhiA}-\ref{Phi(f2 f1)=Phi(f2) Phi(f1)}. 

\begin{remark}
    If $\A$ is such that $\length{\Gamma(A)}=1$ for all objects $A$ in $\A$, then $\ring \A \B$ is highly reminiscent of the category $\A \otimes \B$ as described by Power and Robinson in~\cite{power_premonoidal_1997}. The authors studied the \emph{other} symmetric monoidal closed structure of $\Cat$, where the exponential $[\B,\C]$ is the category of functors from $\B$ to $\C$ and morphisms are simply transformations (not necessarily natural), and $\otimes \B$ is the tensor functor that is the left adjoint of $[\B,-]$. The category $\A \otimes \B$ has pairs $(A,B)$ of objects of $\A$ and $\B$, and a morphism from $(A,B)$ to $(A',B')$ is a finite sequence of non-identity arrows consisting of alternate chains of consecutive morphisms of $\A$ and $\B$. Composition is given by concatenation followed by cancellation accorded by the composition in $\A$ and $\B$, much like our $\ring \A \B$. The only difference with their case is that we have the additional dinaturality equality \ref{Phif_xi dinatural}. For an arbitrary category $\A$ over $\gcf$, our $\ring \A \B$ would be a sort of generalised tensor product, where the number of objects of $\B$ we ``pair up'' with an object $A$ of $\A$ depends on $\Gamma(A)$.
\end{remark}

We are now ready to show that $\fc \B -$ has indeed a left adjoint. This is going to be a crucial step towards a complete substitution calculus for dinatural transformations; we shall discuss some ideas and conjectures about the following steps in the conclusions.

\begin{theorem}\label{theorem:{B,-} has a left adjoint}
    The functor $\FC \B -$ has a left adjoint
    \[
    \begin{tikzcd}[column sep=2cm,bend angle=30]
    {\WCFover\gcf} \ar[r,bend left,"\ring - \B"{name=A},pos=.493] & \Cat \ar[l,bend left,"\FC \B -"{name=B},pos=.507]	
    \ar[from=A,to=B,phantom,"\bot"]
    \end{tikzcd}
    \]
    therefore there is a natural isomorphism
    \begin{equation}\label{natural isomorphism (A circ B, C) -> (A,{B,C})}
    \Cat \bigl( \ring \A \B , \C \bigr) \cong \WCFover\gcf \bigl( \A, \FC \B \C \bigr).
    \end{equation}
    Moreover, $\ring {} {} \colon \WCFover\gcf \times \Cat \to \Cat$ is a functor.
\end{theorem}
\begin{proof}
    Recall that to give an adjunction $ (\ring - \B) \dashv \FC \B -$ is equivalent to give, for all $\A \in \WCFover\gcf$, a universal arrow $(\ring \A \B, F_\A \colon \A \to \FC \B {\ring \A \B})$ from $\A$ to the functor $\FC \B -$; $F_\A$ being a morphism of $\WCFover\gcf$. This means that, for a fixed $\A$, we have to define a functor over $\gcf$ that makes the following triangle commute:
    \[
    \begin{tikzcd}[column sep={1.5cm,between origins}]
    \A \ar[rr,"F_\A"] \ar[dr,"\Gamma"'] & & \FC \B {\ring \A \B} \ar[dl,"\gf"] \\
    & \gcf
    \end{tikzcd}
    \]
    and that is universal among all arrows from $\A$ to $\FC \B -$: for all arrows $(\C, \Phi \colon \A \to \FC \B \C)$ from $\A$ to $\FC \B -$ ($\Phi$ being a functor over $\gcf$), there must exist a unique morphism in $\Cat$, that is a functor, $H \colon \ring \A \B \to \C$ such that
    \[
    \begin{tikzcd}
    \A \ar[r,"F_\A"] \ar[dr,"\Phi"'] & \FC \B {\ring \A \B} \ar[d,"{\FC \B H}"] \\
    & \FC \B \C 
    \end{tikzcd}
    \]
    commutes. In the proof we will refer to properties \ref{PhiA(1...1)=1PhiA}-\ref{Phi(f2 f1)=Phi(f2) Phi(f1)} as given in the definition of $\ring \A \B$.
    
    Let then $\A$ be a category over $\gcf$ with $\Gamma \colon \A \to \gcf$ a weak Conduch fibration. We define the action of $F_\A$ on objects first. If $A$ is an object of $\A$ with $\Gamma(A)=\alpha$, then the assignment
    \[
    \begin{tikzcd}[row sep=0em]
    \B^{\alpha} \ar[r,"F_\A(A)"] & \ring \A \B \\
    \bfB \ar[|->,r] \ar{d}[description,name=A]{\bfg} & A[\bfB] \ar{d}[description,name=B]{{A[\bfg]}}     \\[2em]
    \bfB' \ar[|->,r] & A[\bfB']
    \arrow[from=A,to=B,|->]
    \end{tikzcd}
    \] 
    is a functor by virtue of \ref{PhiA(1...1)=1PhiA} and \ref{PhiA(hg)=PhiA(h)PhiA(g)}. By little abuse of notation, call $F_\A(A)$ also the pair $(\alpha,F_\A(A))$, which is an object of $\FC \B {\ring \A \B}$.
    
    To define $F_\A$ on morphisms, let $f \colon A \to A'$ be a morphism in $\A$, with $\Gamma(A)=\alpha$, $\Gamma(A')=\beta$, let
    \[
    \xi = \bigl(
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd},
    \Delta_\xi
    \bigr) \in \Gamma(f),
    \]
    and call 
    $
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd}
    $
    the skeleton of $(\overline\sigma,\overline\tau,N)$. We define $F_\A (f) \colon F_\A(A) \to F_\A(A')$ to be the equivalent class of the tuple
    \[
    \bigl(
    F_\A (f)_\xi,
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\sigma"] & n & \length\beta \ar[l,"\tau"']
    \end{tikzcd},
    \begin{tikzcd}[cramped,sep=small]
    \length\alpha \ar[r,"\overline\sigma"] & N & \length\beta \ar[l,"\overline\tau"']
    \end{tikzcd},
    \Delta_\xi
    \bigr)
    \]
    where $F_\A(f)_\xi$ is a transformation whose general component is
    \[
    \begin{tikzcd}[row sep=1em,column sep=4em]
    F_\A(A)(\bfB\sigma) \ar[d,phantom,"\rotatebox{90}="] \ar[r,"{f_\xi[\bfB]}"] & F_\A(A')(\bfB\tau) \ar[d,phantom,"\rotatebox{90} ="] \\
    A[\bfB\sigma] & A'[\bfB\tau]
    \end{tikzcd}
    \]
    Then $F_\A(f)_\xi$ is indeed dinatural in its $i$-th variable whenever $\Delta_\xi(i)=1$ because of~\ref{Phif_xi dinatural}.  Moreover, $F_\A$ is well-defined on morphisms because of \ref{Phif_pixi(Bi)=Phif_xi(Bpii)} and is in fact a functor thanks to \ref{Phi(1A)=1_Phi(A)} and \ref{Phi(f2 f1)=Phi(f2) Phi(f1)}. Finally, $F_\A(f)$ so defined is indeed a morphism of $\FC \B {\ring \A \B}$: if $f$ is such that $\Gamma(f)$ is atomic, then $F_\A(f)$ is an atomic morphism of $\FC \B {\ring \A \B}$; if instead $\Gamma(f)=(N_k,\Delta_k) \circ \dots \circ (N_1,\Delta_1)$ where $(N_i,\Delta_i)$ is atomic, then there exists a factorisation $f=f_k \circ \dots \circ f_1$ in $\A$ with $\Gamma(f_i)=(N_i,\Delta_i)$ because $\Gamma$ is a weak Conduch fibration. By functoriality of $F_\A$, we have that $F_\A(f)=F_\A(f_k) \circ \dots \circ F_\A(f_1)$, hence it is a composite of atomic morphisms of $\FC \B {\ring \A \B}$.
    
    We now prove that $F_\A$ is universal. Let then $\Phi \colon \A \to \FC \B \C$ be a morphism in $\WCFover\gcf$, that is a functor over $\gcf$. We define $H \colon \ring \A \B \to \C$ as follows:
    \begin{itemize}[wide=0pt,leftmargin=*]
        \item[\ref{PhiA(B1...Balpha)}] For $A \in \A$ with $\Gamma(A)=\alpha$ and $\bfB \in \B^\alpha$, 
        \[
        H\bigl(A[\bfB]\bigr) = \Phi(A)(\bfB);
        \]
        \item[\ref{PhiA(g1...galpha)}] For $A \in \A$ with $\Gamma(A)=\alpha$, for $\bfg$ in $\B^\alpha$, 
        \[
        H\bigl(A[\bfg]\bigr) = \Phi(A)(\bfg);
        \]
        \item[\ref{Phif}] For $f \colon A \to A'$ in $\A$, $\xi = (N_\xi,\Delta_\xi) \in \Gamma(f)$ where $N_\xi$ has $n$ connected components, for $\bfB \in \B^n$,
        \[
        H\bigl(f_\xi[\bfB]\bigr) = \Phi(f)_\xi(\bfB),
        \]
        where $\Phi(f)_\xi$ is the representative of $\Phi(f)$ whose type is given by the skeleton of $N_\xi$, cf.~the discussion on the data entailed by a functor $\Phi \colon \A \to \FC \B \C$ over $\gcf$ preceding Definition~\ref{definition A ring B}.
    \end{itemize}
    $H$ so defined on the generators of $\ring \A \B$ extends to a unique functor provided that $H$ preserves the equalities \ref{PhiA(1...1)=1PhiA}-\ref{Phi(f2 f1)=Phi(f2) Phi(f1)} in $\ring \A \B$, which it does as they have been designed \emph{precisely} to reflect all the properties of a functor $\Phi \colon \A \to \FC \B \C$, and $H$ is defined using $\Phi$ accordingly. Finally, by construction 
    \[
    \begin{tikzcd}
    \A \ar[r,"F_\A"] \ar[dr,"\Phi"'] & \FC \B {\ring \A \B} \ar[d,"{\FC \B H}"] \\
    & \FC \B \C 
    \end{tikzcd}
    \]
    commutes. The uniqueness of $H$ follows from the fact that the commutativity of the above triangle implies that $\Phi(A)=H(F_\A(A))$ for all $A \in \A$ and $\Phi(f)=H(F_\A(f))$, hence any such functor $H$ \emph{must} be defined as we did to make the triangle commutative. 
    
    With such a universal arrow $(\ring \A \B, F_\A \colon \A \to \FC \B {\ring \A \B})$ we can define a functor $\ring - \B$ which is the left adjoint of $\FC \B -$. Given $F \colon \A \to \A'$ a functor over $\gcf$, by universality of $F_\A$ there exists a unique functor $\ring F \B \colon \ring \A \B \to \ring {\A'} \B$ that makes the following square commute:
    \[
    \begin{tikzcd}
    \A \ar[r,"F_\A"] \ar[d,"F"'] & \FC \B {\ring \A \B} \ar[d,"\FC \B {\ring F \B}"] \\
    \A' \ar[r,"F_{\A'}"'] & \FC \B {\ring {\A'} \B}
    \end{tikzcd}
    \]
    Such $\ring F \B$ is defined on objects as $\ring F \B \bigl( A[\bfB] \bigr) = (F_{\A'} \circ F)(A)(\bfB) = FA[\bfB]$ and on morphisms as
    \[
    \ring F \B \bigl( A[\bfg] \bigr) = FA[\bfg], \quad 
    \ring F \B \bigl( f[\bfB] \bigr) = Ff[\bfB].
    \]
    
    Finally, $\ring{}{}$ extends to a functor
    \[
    \begin{tikzcd}[row sep=0em]
    \WCFover\gcf \times \Cat \ar[r,"\ring{}{}"] & \Cat \\
    \A\quad\quad\,\B \ar[r,|->] \ar[d,shift right=17mu,"F"'] \ar[d,shift left=17mu,"G"] & \ring \A \B \ar[d,"\ring F G"] \\[3em] 
    {\A'}\quad\quad\B' \ar[r,|->] & \ring {\A'} {\B'}
    \end{tikzcd}
    \]
    where $\ring F G$ is defined as follows on the generators:
    \begin{itemize}
        \item $\ring F G \bigl( A[\bfB] \bigr) = FA[G\bfB]$,
        \item $\ring F G \bigl( A[\bfg] \bigr) = FA[G\bfg]$,
        \item $\ring F G \bigl( f[\bfB] \bigr) = Ff[G\bfB]$
    \end{itemize}
    (where $G\bfB=(GB_1,\dots,GB_{\length\alpha})$ if $\bfB=(B_1,\dots,B_{\length\alpha})$). It is easy to see that $\ring F G$ is well defined (i.e.\ it preserves equalities in $\ring \A \B$), thanks to the functoriality of $F$ and $G$. It is also immediate to verify that   $\ring{}{}$ is indeed a functor.\qed
\end{proof}